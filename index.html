<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eagles Analytics - Master Command v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --gold: #FFB81C; --black: #000000; --red: #ef4444; --green: #22c55e; --blue: #3b82f6; }
        body { background-color: #050505; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .bento-card { background: rgba(15, 15, 15, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 1.5rem; transition: 0.3s; }
        .nav-btn { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 10px 14px; border-radius: 9999px; transition: 0.2s; border: 1px solid transparent; }
        .active-nav { background-color: var(--gold); color: black; box-shadow: 0 0 15px rgba(255, 184, 28, 0.3); }
        .inactive-nav { color: #555; border-color: #1a1a1a; }
        .court-svg { width: 100%; max-width: 400px; display: block; margin: 0 auto; filter: drop-shadow(0 0 15px rgba(255,184,28,0.05)); }
        .zone { cursor: pointer; transition: 0.2s; opacity: 0.15; stroke: rgba(255,255,255,0.2); stroke-width: 0.3; fill: transparent; }
        .zone:hover { opacity: 0.7; fill: var(--gold); }
        .zone-label { font-size: 2.2px; font-weight: 900; fill: rgba(255,255,255,0.4); pointer-events: none; text-anchor: middle; text-transform: uppercase; }
        .heat-elite { fill: var(--green); opacity: 0.7; } .heat-poor { fill: var(--red); opacity: 0.7; }
        .stat-input { width: 42px; background: #000; border: 1px solid #222; border-radius: 4px; padding: 4px; text-align: center; font-size: 0.75rem; color: white; font-weight: bold; }
        .progress-fill { height: 100%; transition: width 1s ease-in-out; }
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyA5H5SsumWG7bym_0EZ7jOlfWeswpSauhk", projectId: "eagles-stats", appId: "1:386723096734:web:b50e343c703983e838b38f" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ROSTER = [
            {id: 5, name: "Natasha Mistry", pos: "PG"}, {id: 3, name: "Mikayla Sanders", pos: "PG"}, 
            {id: 22, name: "Christina Lisack", pos: "PG/G"}, {id: 1, name: "Brittney Tang", pos: "G"},
            {id: 2, name: "Kylie Mulcahy", pos: "G"}, {id: 4, name: "Lexi Guild", pos: "G"},
            {id: 10, name: "Reese Jackson", pos: "F"}, {id: 32, name: "Gia Comey", pos: "F"}, 
            {id: 23, name: "Olivia Dozier", pos: "G/F"}, {id: 44, name: "Olivia Fraser", pos: "G/F"},
            {id: 34, name: "Dani Cardona", pos: "C"}, {id: 15, name: "Alexa Troiano", pos: "C"},
            {id: 0, name: "Bela Smith", pos: "C"}
        ];

        const STAT_FIELDS = ['fg2m','fg2a','fg3m','fg3a','ftm','fta','reb','ast','stl','blk','to'];
        const ZONES = ['paint', 'ml', 'mr', '3lc', '3lw', '3t', '3rw', '3rc'];

        function App() {
            const [view, setView] = React.useState('clipboard');
            const [games, setGames] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            // States for Entry/Edit
            const [editId, setEditId] = React.useState(null);
            const [gameMeta, setGameMeta] = React.useState({ date: '', opp: '', oppScore: 0, venue: 'Away', qScores: {q1:0,q2:0,q3:0,q4:0} });
            const [playerStats, setPlayerStats] = React.useState({});
            const [shotMap, setShotMap] = React.useState({ eagles: ZONES.reduce((a,z)=>({...a,[z]:{m:0,x:0}}), {}), opp: ZONES.reduce((a,z)=>({...a,[z]:{m:0,x:0}}), {}) });
            const [plays, setPlays] = React.useState([{ name: '', run: 0, scored: 0, pts: 0 }]);

            React.useEffect(() => {
                const unsub = db.collection('games').orderBy('date', 'desc').onSnapshot(snap => {
                    setGames(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // --- CORE LOGIC: CSV MIGRATION (Verified Fix) ---
            const importCSV = (e) => {
                const file = e.target.files[0]; if(!file) return;
                const r = new FileReader();
                r.onload = async (ev) => {
                    try {
                        const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/; 
                        const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
                        const heads = lines[0].split(regex).map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));
                        const batch = db.batch(); const gMap = {};

                        for(let i=1; i<lines.length; i++) {
                            const v = lines[i].split(regex).map(x => x.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                            const d = {}; heads.forEach((h,idx)=> d[h] = v[idx]);
                            const opponent = d.opponent || d.opp; const k = `${d.date}_${opponent}`;
                            if(!gMap[k]) {
                                gMap[k] = { 
                                    date: d.date, opp: opponent, oppScore: parseInt(d.oppscore)||0, 
                                    venue: d.venue||'Away', stats:[], 
                                    plays: JSON.parse(d.setplays_json || d.plays_json || "[]"), 
                                    shotMap: JSON.parse(d.shotmap_json || d.map_json || '{"eagles":{},"opp":{}}') 
                                };
                            }
                            gMap[k].stats.push({ 
                                name: d.player, fg2m: parseInt(d['2pm'])||0, fg2a: parseInt(d['2pa'])||0, 
                                fg3m: parseInt(d['3pm'])||0, fg3a: parseInt(d['3pa'])||0, 
                                ftm: parseInt(d.ftm)||0, fta: parseInt(d.fta)||0, reb: parseInt(d.reb)||0, 
                                ast: parseInt(d.ast)||0, stl: parseInt(d.stl)||0, blk: parseInt(d.blk)||0, 
                                to: parseInt(d.to)||0, pts: parseInt(d.pts)||0 
                            });
                        }
                        Object.values(gMap).forEach(doc => {
                            doc.teamScore = doc.stats.reduce((a,c)=> a + c.pts, 0);
                            doc.result = doc.teamScore > doc.oppScore ? 'W' : 'L';
                            batch.set(db.collection('games').doc(), doc);
                        });
                        await batch.commit(); alert("Production Cloud Restored!"); window.location.reload();
                    } catch (err) { alert("Restore Error: Check CSV formatting."); }
                };
                r.readAsText(file);
            };

            const saveGame = async () => {
                if (!gameMeta.date || !gameMeta.opp) return alert("Header Required.");
                const teamScore = ROSTER.reduce((acc, p) => acc + (((playerStats[p.name]?.fg2m||0)*2) + ((playerStats[p.name]?.fg3m||0)*3) + (playerStats[p.name]?.ftm||0)), 0);
                const stats = ROSTER.map(p => ({ ...p, ...playerStats[p.name], pts: (((playerStats[p.name]?.fg2m||0)*2) + ((playerStats[p.name]?.fg3m||0)*3) + (playerStats[p.name]?.ftm||0)) }));
                const payload = { ...gameMeta, teamScore, stats, shotMap, plays: plays.filter(p=>p.name), result: teamScore > gameMeta.oppScore ? 'W' : 'L', updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                if(editId) await db.collection('games').doc(editId).update(payload);
                else await db.collection('games').add(payload);
                alert("Game Synced! ü¶Ö"); setEditId(null); resetForm(); setView('log');
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-black text-gold font-black italic tracking-tighter text-5xl animate-pulse">EAGLES COMMAND</div>;

            return (
                <div className="pb-20 no-scrollbar">
                    <header className="sticky top-0 z-[100] bg-black/80 backdrop-blur-xl border-b border-white/5 p-4 xl:p-6 shadow-2xl no-print">
                        <div className="max-w-7xl mx-auto flex flex-col xl:flex-row justify-between items-center gap-6">
                            <div className="flex items-center gap-4">
                                <div className="bg-white w-12 h-12 rounded-full flex items-center justify-center border-2 border-gold shadow-lg transform -rotate-3"><span className="text-2xl">ü¶Ö</span></div>
                                <div><h1 className="text-3xl font-black uppercase italic tracking-tighter leading-none">Eagles <span className="text-gold">Analytics</span></h1><p className="text-[9px] uppercase tracking-[0.3em] text-zinc-500 mt-1 font-black">2026 Season Command Center</p></div>
                            </div>
                            <nav className="flex gap-1 overflow-x-auto no-scrollbar w-full xl:w-auto pb-2">
                                {['new','trends','tactics','defense','clipboard','goals','log','settings'].map(t => (
                                    <button key={t} onClick={() => setView(t)} className={`nav-btn ${view === t ? 'active-nav' : 'inactive-nav'}`}>{t}</button>
                                ))}
                            </nav>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-10 animate-pop">
                        
                        {/* TAB: DEFENSE (Opponent Mapping) */}
                        {view === 'defense' && (
                            <div className="space-y-10">
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-6">
                                    <BentoStat label="Opp PPG" value={games.length ? (games.reduce((a,b)=>a+b.oppScore,0)/games.length).toFixed(1) : '0.0'} color="text-red-500" />
                                    <BentoStat label="Steals PG" value={games.length ? (games.reduce((a,b)=>a+b.stats.reduce((x,y)=>x+y.stl,0),0)/games.length).toFixed(1) : '0.0'} />
                                    <BentoStat label="Blocks PG" value={games.length ? (games.reduce((a,b)=>a+b.stats.reduce((x,y)=>x+y.blk,0),0)/games.length).toFixed(1) : '0.0'} />
                                    <BentoStat label="TO Forced" value={games.length ? (games.reduce((a,b)=>a+b.stats.reduce((x,y)=>x+y.to,0),0)/games.length).toFixed(1) : '0.0'} />
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                                    <div className="bento-card text-center border-t-4 border-red-500">
                                        <h3 className="text-red-500 font-black italic uppercase mb-6 tracking-widest">Defensive Heatmap</h3>
                                        <HeatMap type="opp" games={games} />
                                    </div>
                                    <div className="bento-card">
                                        <h3 className="text-white font-black italic uppercase mb-6 border-b border-white/5 pb-2">Exposed Zones</h3>
                                        <div className="space-y-4">
                                            {ZONES.map(z => {
                                                const m = games.reduce((acc,g)=>acc+g.shotMap.opp[z].m,0);
                                                const x = games.reduce((acc,g)=>acc+g.shotMap.opp[z].x,0);
                                                const pct = (m/(m+x)*100);
                                                if(pct > 45) return <div key={z} className="flex justify-between p-3 bg-red-950/20 border border-red-900 rounded-xl"><span className="text-[10px] font-black uppercase text-red-400">{z.toUpperCase()} ALERT</span><span className="font-black italic text-red-400">{pct.toFixed(1)}% SUCCESS</span></div>;
                                                return null;
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* TAB: TRENDS (Quarterly Analysis) */}
                        {view === 'trends' && (
                            <div className="grid grid-cols-1 gap-10">
                                <div className="bento-card h-[400px]">
                                    <h3 className="text-gold font-black uppercase italic mb-6">Scoring Progression</h3>
                                    <LineChart games={games} />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <BentoStat label="Venue Split (Home)" value={games.filter(g=>g.venue==='Home').length + " GP"} sub={games.filter(g=>g.venue==='Home' && g.result==='W').length + " WINS"} />
                                    <BentoStat label="Venue Split (Away)" value={games.filter(g=>g.venue==='Away').length + " GP"} sub={games.filter(g=>g.venue==='Away' && g.result==='W').length + " WINS"} />
                                </div>
                            </div>
                        )}

                        {/* TAB: CLIPBOARD (Master Overview) */}
                        {view === 'clipboard' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-pop">
                                <BentoStat label="Season Record" value={`${games.filter(g=>g.result==='W').length}-${games.filter(g=>g.result==='L').length}`} />
                                <BentoStat label="PPG" value={games.length ? (games.reduce((a,b)=>a+b.teamScore,0)/games.length).toFixed(1) : '0.0'} color="text-gold" />
                                <BentoStat label="Opp PPG" value={games.length ? (games.reduce((a,b)=>a+b.oppScore,0)/games.length).toFixed(1) : '0.0'} color="text-red-500" />
                                <BentoStat label="Logged Data" value={games.length} sub="Official Recs" />
                            </div>
                        )}

                        {/* TAB: SETTINGS (Migration) */}
                        {view === 'settings' && (
                            <div className="max-w-2xl mx-auto py-20">
                                <div className="bento-card text-center border-t-8 border-gold p-12 shadow-gold/10 shadow-2xl">
                                    <h2 className="text-3xl font-black text-gold uppercase italic mb-8">Cloud Governance</h2>
                                    <div className="flex flex-col gap-4">
                                        <label className="w-full bg-blue-900 border border-blue-800 text-white p-6 rounded-2xl font-black uppercase text-xs cursor-pointer hover:bg-blue-800 transition shadow-blue-900/20 shadow-lg">
                                            üì§ Restore Season Database from CSV
                                            <input type="file" className="hidden" accept=".csv" onChange={importCSV} />
                                        </label>
                                        <div className="mt-12 pt-12 border-t border-white/5"><button onClick={async()=>{if(confirm("Wipe all logs?")) { const s = await db.collection('games').get(); s.forEach(d=>d.ref.delete()); alert("Purged."); }}} className="w-full bg-red-950/20 text-red-500 border border-red-900 p-6 rounded-2xl font-black uppercase text-xs hover:bg-red-900">‚ö†Ô∏è Erase Complete Season Records</button></div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // --- SUB-COMPONENTS ---
        function BentoStat({ label, value, color, sub }) {
            return (
                <div className="bento-card text-center flex flex-col justify-center">
                    <div className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-1">{label}</div>
                    <div className={`text-5xl font-black italic tracking-tighter ${color||'text-white'}`}>{value}</div>
                    {sub && <div className="text-[8px] font-black uppercase text-zinc-700 mt-2">{sub}</div>}
                </div>
            );
        }

        function HeatMap({ type, games }) {
            const data = games.reduce((acc, g) => { ZONES.forEach(z => { acc[z].m += g.shotMap[type][z].m; acc[z].x += g.shotMap[type][z].x; }); return acc; }, ZONES.reduce((a,z)=>({...a,[z]:{m:0,x:0}}), {}));
            const getHeat = (z) => {
                const att = data[z].m + data[z].x; if(!att) return '';
                const pct = (data[z].m / att) * 100;
                return pct >= 50 ? 'heat-elite' : pct >= 35 ? 'heat-good' : 'heat-poor';
            };
            return (
                <svg viewBox="0 0 50 47" className="court-svg">
                    <rect x="0" y="0" width="50" height="47" fill="#000" stroke="#111" strokeWidth="0.5"/>
                    <path className={`zone ${getHeat('paint')}`} d="M 19,47 L 19,32 L 31,32 L 31,47 Z" />
                    <text x="25" y="42" className="zone-label">PAINT</text>
                    <path className={`zone ${getHeat('3t')}`} d="M 15,0 L 35,0 L 35,15 L 15,15 Z" />
                    <text x="25" y="10" className="zone-label">3PT TOP</text>
                </svg>
            );
        }

        function LineChart({ games }) {
            const canvasRef = React.useRef(null);
            React.useEffect(() => {
                if(!games.length) return;
                const sorted = [...games].reverse();
                new Chart(canvasRef.current, {
                    type: 'line',
                    data: { labels: sorted.map(g=>g.opp), datasets: [{ label: 'Eagles', data: sorted.map(g=>g.teamScore), borderColor: '#FFB81C', tension: 0.4 }, { label: 'Opponent', data: sorted.map(g=>g.oppScore), borderColor: '#ef4444', tension: 0.4 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#111' } }, x: { grid: { display: false } } } }
                });
            }, [games]);
            return <canvas ref={canvasRef}></canvas>;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
