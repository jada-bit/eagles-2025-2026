<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eagles Analytics - Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --gold: #FFB81C; --black: #050505; --red: #ef4444; --green: #22c55e; }
        body { background-color: var(--black); color: white; font-family: 'Inter', system-ui, sans-serif; overflow-x: hidden; }
        
        /* Modular Bento Grid */
        .bento-card { 
            background: rgba(20, 20, 20, 0.6); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-radius: 20px; 
            padding: 1.5rem; 
            transition: 0.3s ease; 
        }
        .bento-card:hover { border-color: var(--gold); transform: translateY(-2px); }

        /* Navigation */
        .nav-btn { font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 12px 20px; border-radius: 99px; transition: 0.2s; white-space: nowrap; border: 1px solid transparent; cursor: pointer; }
        .active-nav { background-color: var(--gold); color: black; box-shadow: 0 0 20px rgba(255, 184, 28, 0.4); }
        .inactive-nav { color: #888; border-color: #333; background: rgba(255,255,255,0.03); }
        .inactive-nav:hover { color: white; border-color: #666; }

        /* Court Geometry */
        .court-svg { width: 100%; display: block; margin: 0 auto; filter: drop-shadow(0 0 10px rgba(255,184,28,0.1)); touch-action: manipulation; }
        .zone { cursor: pointer; transition: 0.2s; opacity: 0.2; stroke: rgba(255,255,255,0.3); stroke-width: 0.5; fill: transparent; }
        .zone:hover { opacity: 0.6; fill: var(--gold); }
        .zone-label { font-size: 2.5px; font-weight: 900; fill: rgba(255,255,255,0.5); pointer-events: none; text-anchor: middle; }

        /* Inputs & Controls */
        .stat-input { width: 100%; background: #111; border: 1px solid #333; border-radius: 6px; padding: 8px; text-align: center; color: white; font-weight: bold; font-size: 14px; }
        .stat-input:focus { border-color: var(--gold); outline: none; background: #000; }
        
        /* Animations */
        .animate-fade { animation: fade 0.5s ease-out; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = { apiKey: "AIzaSyA5H5SsumWG7bym_0EZ7jOlfWeswpSauhk", projectId: "eagles-stats", appId: "1:386723096734:web:b50e343c703983e838b38f" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ROSTER = [
            {id: 5, name: "Natasha Mistry", pos: "PG"}, {id: 3, name: "Mikayla Sanders", pos: "PG"}, 
            {id: 22, name: "Christina Lisack", pos: "PG/G"}, {id: 1, name: "Brittney Tang", pos: "G"},
            {id: 2, name: "Kylie Mulcahy", pos: "G"}, {id: 4, name: "Lexi Guild", pos: "G"},
            {id: 10, name: "Reese Jackson", pos: "F"}, {id: 32, name: "Gia Comey", pos: "F"}, 
            {id: 23, name: "Olivia Dozier", pos: "G/F"}, {id: 44, name: "Olivia Fraser", pos: "G/F"},
            {id: 34, name: "Dani Cardona", pos: "C"}, {id: 15, name: "Alexa Troiano", pos: "C"},
            {id: 0, name: "Bela Smith", pos: "G/F"}
        ];

        // Complete Court Zones Mapping
        const ZONES = ['paint', 'mid_l', 'mid_r', 'mid_c', 'corn_l', 'corn_r', 'wing_l', 'wing_r', 'top'];
        const STAT_FIELDS = ['fg2m','fg2a','fg3m','fg3a','ftm','fta','reb','ast','stl','to'];

        // --- COMPONENTS ---

        function App() {
            const [view, setView] = React.useState('clipboard');
            const [games, setGames] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            // Game State
            const [gameMeta, setGameMeta] = React.useState({ date: new Date().toISOString().split('T')[0], opp: '', oppScore: 0, venue: 'Home' });
            const [playerStats, setPlayerStats] = React.useState({});
            const [shotMap, setShotMap] = React.useState({ eagles: ZONES.reduce((a,z)=>({...a,[z]:{m:0,x:0}}), {}), opp: ZONES.reduce((a,z)=>({...a,[z]:{m:0,x:0}}), {}) });
            const [plays, setPlays] = React.useState([]);
            
            // UX State for "All Ages" usability
            const [shotMode, setShotMode] = React.useState('make'); // 'make' or 'miss'
            const [editId, setEditId] = React.useState(null);

            React.useEffect(() => {
                const unsub = db.collection('games').orderBy('date', 'desc').onSnapshot(snap => {
                    setGames(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            const handleStatChange = (player, field, value) => {
                const safeVal = Math.max(0, parseInt(value) || 0);
                setPlayerStats(prev => ({
                    ...prev,
                    [player]: { ...prev[player], [field]: safeVal }
                }));
            };

            const saveGame = async () => {
                if (!gameMeta.opp) return alert("Please enter an Opponent Name.");
                
                // Calc Totals
                let tScore = 0;
                const stats = ROSTER.map(p => {
                    const ps = playerStats[p.name] || {};
                    const pts = ((ps.fg2m||0)*2) + ((ps.fg3m||0)*3) + (ps.ftm||0);
                    tScore += pts;
                    return { ...p, ...ps, pts };
                });

                const payload = { 
                    ...gameMeta, 
                    teamScore: tScore, 
                    stats, 
                    shotMap, 
                    plays, 
                    result: tScore > gameMeta.oppScore ? 'W' : 'L',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                };
                
                try {
                    if (editId) await db.collection('games').doc(editId).update(payload);
                    else await db.collection('games').add(payload);
                    alert("Game Saved Successfully!"); 
                    setEditId(null); 
                    setPlayerStats({});
                    setView('log');
                } catch (e) { alert("Error saving: " + e.message); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-gold text-2xl font-black animate-pulse">LOADING EAGLES COMMAND...</div>;

            return (
                <div className="min-h-screen pb-20">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-black/90 backdrop-blur border-b border-white/10 p-4 shadow-2xl">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="text-3xl">ðŸ¦…</div>
                                <div>
                                    <h1 className="text-2xl font-black uppercase italic tracking-tighter text-white">Eagles <span className="text-gold">Analytics</span></h1>
                                </div>
                            </div>
                            <nav className="flex gap-2 overflow-x-auto w-full md:w-auto pb-1 no-scrollbar">
                                {['clipboard', 'new', 'trends', 'log'].map(t => (
                                    <button key={t} onClick={() => setView(t)} className={`nav-btn ${view === t ? 'active-nav' : 'inactive-nav'}`}>{t}</button>
                                ))}
                            </nav>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 animate-fade">
                        
                        {/* --- VIEW: CLIPBOARD (Dashboard) --- */}
                        {view === 'clipboard' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <BentoCard label="Record" value={`${games.filter(g=>g.result==='W').length}-${games.filter(g=>g.result==='L').length}`} sub="Wins - Losses" />
                                <BentoCard label="Avg Points" value={games.length ? (games.reduce((a,b)=>a+b.teamScore,0)/games.length).toFixed(1) : '-'} color="text-gold" />
                                <BentoCard label="Defense (Opp PPG)" value={games.length ? (games.reduce((a,b)=>a+b.oppScore,0)/games.length).toFixed(1) : '-'} />
                                <BentoCard label="Total Games" value={games.length} />
                                
                                <div className="col-span-1 md:col-span-2 lg:col-span-4 bento-card border-l-4 border-gold">
                                    <h3 className="text-gold font-black uppercase mb-4">Latest Result</h3>
                                    {games[0] ? (
                                        <div className="flex items-center justify-between">
                                            <div className="text-3xl md:text-5xl font-black italic">{games[0].result} vs {games[0].opp}</div>
                                            <div className="text-right">
                                                <div className="text-zinc-500 text-xs font-bold uppercase">{games[0].date}</div>
                                                <div className="text-xl font-bold">Score: {games[0].teamScore} - {games[0].oppScore}</div>
                                            </div>
                                        </div>
                                    ) : <div className="text-zinc-500 italic">No games logged yet.</div>}
                                </div>
                            </div>
                        )}

                        {/* --- VIEW: NEW GAME (Data Entry) --- */}
                        {view === 'new' && (
                            <div className="space-y-6">
                                {/* Game Metadata */}
                                <div className="bento-card grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="space-y-1"><label className="text-xs font-bold text-zinc-500">DATE</label><input type="date" value={gameMeta.date} onChange={e=>setGameMeta({...gameMeta, date:e.target.value})} className="w-full bg-black border border-zinc-800 rounded p-3 text-white font-bold" /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-zinc-500">OPPONENT</label><input type="text" placeholder="Team Name" value={gameMeta.opp} onChange={e=>setGameMeta({...gameMeta, opp:e.target.value})} className="w-full bg-black border border-zinc-800 rounded p-3 text-white font-bold uppercase" /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-zinc-500">OPP SCORE</label><input type="number" value={gameMeta.oppScore} onChange={e=>setGameMeta({...gameMeta, oppScore:parseInt(e.target.value)})} className="w-full bg-black border border-zinc-800 rounded p-3 text-white font-bold" /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-zinc-500">VENUE</label><select value={gameMeta.venue} onChange={e=>setGameMeta({...gameMeta, venue:e.target.value})} className="w-full bg-black border border-zinc-800 rounded p-3 text-white font-bold"><option>Home</option><option>Away</option><option>Neutral</option></select></div>
                                </div>

                                {/* Shot Charting */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bento-card">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-black text-gold uppercase">Team Shot Chart</h3>
                                            {/* Kid-Friendly Toggle */}
                                            <div className="flex bg-black rounded-lg p-1 border border-zinc-800">
                                                <button onClick={()=>setShotMode('make')} className={`px-4 py-1 rounded font-bold text-xs uppercase ${shotMode==='make'?'bg-green-500 text-black':'text-zinc-500'}`}>Made</button>
                                                <button onClick={()=>setShotMode('miss')} className={`px-4 py-1 rounded font-bold text-xs uppercase ${shotMode==='miss'?'bg-red-500 text-black':'text-zinc-500'}`}>Missed</button>
                                            </div>
                                        </div>
                                        <p className="text-xs text-zinc-500 mb-2 text-center italic">Tap a zone to record a {shotMode === 'make' ? 'MAKE' : 'MISS'}</p>
                                        <InteractiveCourt 
                                            data={shotMap.eagles} 
                                            mode={shotMode}
                                            onClick={(zone, isMake) => {
                                                const current = shotMap.eagles[zone];
                                                setShotMap({
                                                    ...shotMap,
                                                    eagles: {
                                                        ...shotMap.eagles,
                                                        [zone]: { m: current.m + (isMake?1:0), x: current.x + (isMake?0:1) }
                                                    }
                                                });
                                            }}
                                        />
                                    </div>

                                    {/* Player Stats Grid */}
                                    <div className="bento-card overflow-x-auto">
                                        <h3 className="font-black text-gold uppercase mb-4 sticky left-0">Player Box Score</h3>
                                        <table className="w-full text-xs">
                                            <thead>
                                                <tr className="text-zinc-500 border-b border-white/10">
                                                    <th className="p-2 text-left">PLAYER</th>
                                                    <th className="p-1">2PM</th><th className="p-1">2PA</th>
                                                    <th className="p-1">3PM</th><th className="p-1">3PA</th>
                                                    <th className="p-1">FTM</th><th className="p-1">FTA</th>
                                                    <th className="p-1">REB</th><th className="p-1">AST</th>
                                                    <th className="p-1">STL</th><th className="p-1">TO</th>
                                                    <th className="p-1 text-gold">PTS</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {ROSTER.map(p => {
                                                    const s = playerStats[p.name] || {};
                                                    const pts = ((s.fg2m||0)*2) + ((s.fg3m||0)*3) + (s.ftm||0);
                                                    return (
                                                        <tr key={p.id} className="border-b border-white/5 hover:bg-white/5">
                                                            <td className="p-3 font-bold whitespace-nowrap">{p.name} <span className="text-[9px] text-zinc-500 ml-1">{p.pos}</span></td>
                                                            {STAT_FIELDS.map(f => (
                                                                <td key={f} className="p-1"><input type="number" className="stat-input" placeholder="0" value={s[f]||''} onChange={(e)=>handleStatChange(p.name, f, e.target.value)} /></td>
                                                            ))}
                                                            <td className="p-1 font-black text-gold text-center text-sm">{pts}</td>
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <button onClick={saveGame} className="w-full bg-gold hover:bg-white text-black py-4 rounded-xl font-black text-lg uppercase transition shadow-lg shadow-gold/20">
                                    Save Game Data
                                </button>
                            </div>
                        )}

                        {/* --- VIEW: TRENDS (Charts) --- */}
                        {view === 'trends' && (
                            <div className="space-y-6">
                                <div className="bento-card">
                                    <h3 className="text-gold font-black uppercase mb-6">Season Scoring Trend</h3>
                                    <div className="h-64 w-full">
                                        <TrendChart games={games} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- VIEW: LOG (History) --- */}
                        {view === 'log' && (
                            <div className="grid gap-4">
                                {games.map(g => (
                                    <div key={g.id} className="bento-card flex justify-between items-center group">
                                        <div>
                                            <div className="text-xs font-bold text-zinc-500 uppercase">{g.date} â€¢ {g.venue}</div>
                                            <div className="text-2xl font-black italic">
                                                <span className={g.result==='W'?'text-green-500':'text-red-500'}>{g.result}</span> vs {g.opp}
                                            </div>
                                            <div className="text-sm font-bold mt-1">Eagles {g.teamScore} - {g.opp} {g.oppScore}</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => {
                                                setEditId(g.id);
                                                setGameMeta({date:g.date, opp:g.opp, oppScore:g.oppScore, venue:g.venue});
                                                const statsMap = {};
                                                g.stats.forEach(s => statsMap[s.name] = s);
                                                setPlayerStats(statsMap);
                                                setShotMap(g.shotMap || { eagles: {}, opp: {} });
                                                setView('new');
                                            }} className="px-4 py-2 bg-zinc-800 rounded text-xs font-bold uppercase hover:bg-gold hover:text-black">Edit</button>
                                        </div>
                                    </div>
                                ))}
                                {games.length === 0 && <div className="text-center py-20 opacity-50">No games recorded yet. Go to "NEW" to start.</div>}
                            </div>
                        )}

                    </main>
                </div>
            );
        }

        // --- SUB-COMPONENTS ---

        function BentoCard({ label, value, color, sub }) {
            return (
                <div className="bento-card flex flex-col items-center justify-center text-center">
                    <div className="text-[10px] font-bold uppercase text-zinc-500 tracking-widest mb-2">{label}</div>
                    <div className={`text-4xl lg:text-5xl font-black italic tracking-tighter ${color || 'text-white'}`}>{value}</div>
                    {sub && <div className="text-[9px] uppercase font-bold text-zinc-600 mt-2">{sub}</div>}
                </div>
            )
        }

        // Expanded Court Diagram
        function InteractiveCourt({ data, onClick, mode }) {
            // Helper to get fill color based on data
            const getFill = (key) => {
                const zone = data[key] || {m:0, x:0};
                const total = zone.m + zone.x;
                if(total === 0) return 'transparent';
                const pct = zone.m / total;
                // Heatmap logic: Green if > 40%, Red if < 30%
                if(pct >= 0.4) return 'rgba(34, 197, 94, 0.6)'; 
                return 'rgba(239, 68, 68, 0.6)';
            };

            return (
                <div className="relative max-w-[400px] mx-auto select-none">
                    <svg viewBox="0 0 100 94" className="court-svg">
                        {/* Court Background */}
                        <rect x="0" y="0" width="100" height="94" fill="#111" stroke="#333" strokeWidth="1"/>
                        
                        {/* Paint */}
                        <path d="M 35,94 L 35,55 L 65,55 L 65,94 Z" className="zone" 
                              fill={getFill('paint')} onClick={()=>onClick('paint', mode==='make')} />
                        
                        {/* 3PT Line Arc (Approximation) */}
                        <path d="M 10,94 L 10,15 Q 50,-15 90,15 L 90,94" fill="none" stroke="#555" strokeWidth="1" strokeDasharray="4,4" pointerEvents="none"/>

                        {/* Mid-Range Zones */}
                        <path d="M 10,55 L 35,55 L 35,94 L 10,94 Z" className="zone" onClick={()=>onClick('mid_l', mode==='make')} fill={getFill('mid_l')} />
                        <path d="M 65,55 L 90,55 L 90,94 L 65,94 Z" className="zone" onClick={()=>onClick('mid_r', mode==='make')} fill={getFill('mid_r')} />
                        <path d="M 35,55 L 35,30 L 65,30 L 65,55 Z" className="zone" onClick={()=>onClick('mid_c', mode==='make')} fill={getFill('mid_c')} />
                        
                        {/* 3PT Zones */}
                        <path d="M 0,94 L 0,60 L 10,60 L 10,94 Z" className="zone" onClick={()=>onClick('corn_l', mode==='make')} fill={getFill('corn_l')} />
                        <path d="M 90,94 L 90,60 L 100,60 L 100,94 Z" className="zone" onClick={()=>onClick('corn_r', mode==='make')} fill={getFill('corn_r')} />
                        <path d="M 0,60 L 0,0 L 30,0 L 35,30 L 10,55 Z" className="zone" onClick={()=>onClick('wing_l', mode==='make')} fill={getFill('wing_l')} />
                        <path d="M 100,60 L 100,0 L 70,0 L 65,30 L 90,55 Z" className="zone" onClick={()=>onClick('wing_r', mode==='make')} fill={getFill('wing_r')} />
                        <path d="M 30,0 L 70,0 L 65,30 L 35,30 Z" className="zone" onClick={()=>onClick('top', mode==='make')} fill={getFill('top')} />

                        {/* Labels */}
                        <text x="50" y="80" className="zone-label">PAINT ({data.paint?.m}/{data.paint?.m+data.paint?.x})</text>
                        <text x="50" y="20" className="zone-label">TOP 3 ({data.top?.m}/{data.top?.m+data.top?.x})</text>
                    </svg>
                </div>
            );
        }

        // Chart.js Component
        function TrendChart({ games }) {
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                const ctx = canvasRef.current.getContext('2d');
                if (chartRef.current) chartRef.current.destroy();

                const sorted = [...games].reverse(); // Oldest first

                chartRef.current
