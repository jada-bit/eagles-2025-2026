<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eagles Analytics - Master Command</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --gold: #FFB81C; --black: #050505; --red: #ef4444; --green: #22c55e; --blue: #3b82f6; --zinc: #18181b; }
        body { background-color: var(--black); color: white; font-family: system-ui, -apple-system, sans-serif; -webkit-print-color-adjust: exact; touch-action: manipulation; }
        
        /* UTILS */
        .bento-card { background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .nav-btn { font-size: 10px; font-weight: 800; text-transform: uppercase; padding: 10px 14px; border-radius: 99px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .active-nav { background-color: var(--gold); color: black; box-shadow: 0 0 15px rgba(255, 184, 28, 0.3); }
        .inactive-nav { background: rgba(255,255,255,0.05); color: #888; }
        
        /* LIVE MODE & HUD */
        .live-header { background: #000; border-bottom: 4px solid var(--gold); padding: 10px 15px; position: sticky; top: 0; z-index: 40; display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center; }
        .score-val { font-size: 3rem; font-weight: 900; line-height: 1; text-align: center; }
        .score-label { font-size: 0.7rem; font-weight: 900; letter-spacing: 2px; color: #888; text-transform: uppercase; }
        
        .coach-hud { display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 6px; padding: 8px; background: #111; border-bottom: 1px solid #333; align-items: center; }
        .hud-box { text-align: center; background: #222; padding: 6px; border-radius: 6px; border: 1px solid #333; position: relative; }
        .hud-label { font-size: 8px; font-weight: 900; color: #888; text-transform: uppercase; }
        .hud-val { font-size: 14px; font-weight: 900; color: white; }
        .bonus-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 8px; font-weight: 900; padding: 2px 4px; border-radius: 4px; animation: pulse 2s infinite; }
        
        /* TIMEOUTS & POSSESSION */
        .timeout-pills { display: flex; gap: 4px; justify-content: center; margin-top: 4px; }
        .to-pill { width: 18px; height: 18px; border-radius: 50%; font-size: 8px; font-weight: 900; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #333; transition: 0.2s; }
        .to-pill.active { background: var(--gold); color: black; border-color: white; }
        .to-pill.used { background: #333; color: #555; border-color: #222; }
        
        .poss-arrow { font-size: 2rem; cursor: pointer; user-select: none; transition: 0.2s; filter: drop-shadow(0 0 5px rgba(255, 184, 28, 0.5)); }
        .poss-arrow:active { transform: scale(0.9); }

        /* QUARTER SELECTOR */
        .q-selector { display: flex; gap: 2px; padding: 2px; background: #222; border-radius: 6px; justify-content: center; }
        .q-btn { flex: 1; padding: 6px 4px; font-size: 10px; font-weight: 900; color: #666; background: transparent; border-radius: 4px; transition: all 0.2s; border: 1px solid transparent; }
        .q-btn.active { background: var(--gold); color: black; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .q-btn:hover:not(.active) { background: rgba(255,255,255,0.1); color: white; }

        /* SNAPSHOT DESIGN (NEW) */
        .snap-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .snap-stat-box { background: #111; border: 1px solid #333; padding: 12px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .snap-stat-label { font-size: 10px; font-black; color: #666; uppercase; letter-spacing: 1px; }
        .snap-stat-val { font-size: 24px; font-black; line-height: 1; margin-top: 4px; }
        .snap-stat-sub { font-size: 10px; font-bold; color: #888; margin-top: 2px; }
        
        .outlier-section { margin-top: 10px; }
        .outlier-card { display: flex; align-items: center; gap: 10px; padding: 10px; background: #222; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #555; }
        .outlier-icon { font-size: 20px; }
        .outlier-name { font-weight: bold; font-size: 14px; flex: 1; }
        .outlier-detail { font-weight: 900; font-size: 12px; color: #fff; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; }

        /* BIG BUTTONS */
        .kb-player-btn { position: relative; height: 100%; width: 100%; min-height: 75px; background: #18181b; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.1s; cursor: pointer; }
        .kb-player-btn.selected { background: var(--gold); color: black; border-color: white; transform: scale(1.02); box-shadow: 0 0 15px rgba(255, 184, 28, 0.4); z-index: 10; }
        .kb-opp-btn { background: #450a0a; border: 1px solid #ef4444; color: white; }
        .kb-opp-btn.selected { background: #ef4444; color: white; border-color: white; transform: scale(1.02); box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .kb-stat-btn { height: 100%; width: 100%; min-height: 50px; border-radius: 6px; font-weight: 900; font-size: 12px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; transition: 0.1s; border: 1px solid rgba(255,255,255,0.1); }
        .kb-stat-btn:active { transform: scale(0.95); }
        .bg-make { background: #166534; color: white; }
        .bg-miss { background: #7f1d1d; color: white; }
        .bg-action { background: #1e3a8a; color: white; }
        .bg-neg { background: #3f3f46; color: #a1a1aa; }

        /* EVENT FEED */
        .event-feed { background: #111; border-top: 1px solid #333; overflow-y: auto; height: 300px; padding: 10px; display: flex; flex-direction: column-reverse; gap: 8px; -webkit-overflow-scrolling: touch; }
        .event-item { background: #222; border: 1px solid #333; padding: 12px 16px; border-radius: 8px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; animation: slideInLeft 0.2s; cursor: pointer; border-left: 4px solid var(--gold); min-height: 50px; }
        .event-item:hover { background: #333; border-color: #555; }
        .undo-hint { color: #ef4444; font-weight: 900; font-size: 11px; text-transform: uppercase; padding: 4px 8px; border: 1px solid rgba(239,68,68,0.3); border-radius: 4px; background: rgba(239,68,68,0.1); }

        /* ALERTS */
        .alert-ticker { background: #222; padding: 8px 12px; border-bottom: 1px solid #333; display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; }
        .live-alert { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: bold; animation: slideIn 0.3s; }
        .live-alert.bad { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.5); color: #fca5a5; }
        .live-alert.warn { background: rgba(234,179,8,0.2); border: 1px solid rgba(234,179,8,0.5); color: #fcd34d; }
        .live-alert.good { background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.5); color: #86efac; }
        .trend-card { background: #222; border-left: 4px solid; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .trend-title { font-weight: 900; font-size: 14px; text-transform: uppercase; margin-bottom: 4px; }
        .trend-desc { font-size: 13px; color: #aaa; line-height: 1.4; }

        /* TABLE & GENERAL */
        .stat-table th { position: sticky; top: 0; background: #111; z-index: 10; font-size: 10px; text-transform: uppercase; color: #888; padding: 10px; cursor: pointer; }
        .stat-table th:hover { color: var(--gold); }
        .stat-row:hover { background: rgba(255,255,255,0.05); }
        .stat-input { background: #111; border: 1px solid #333; color: white; padding: 4px; text-align: center; border-radius: 4px; width: 100%; font-weight: bold; font-size: 12px; }
        .stepper-btn { width: 20px; height: 24px; display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #333; color: #888; font-size: 10px; cursor: pointer; border-radius: 4px; }
        .sub-icon { position: absolute; top: 4px; right: 4px; font-size: 10px; background: #333; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 1px solid #555; }
        .sub-icon:hover { background: var(--gold); color: black; }
        .player-card-bench { background: #111; border: 1px solid #333; border-radius: 8px; padding: 12px; cursor: pointer; opacity: 0.6; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .player-card-bench:hover { border-color: var(--gold); opacity: 1; background: #222; }

        /* CHAT UI */
        .chat-bubble { padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; max-width: 85%; font-size: 14px; line-height: 1.5; animation: slideIn 0.2s; white-space: pre-wrap; }
        .chat-user { background: #333; align-self: flex-end; margin-left: auto; color: white; border-bottom-right-radius: 2px; }
        .chat-bot { background: var(--gold); color: black; align-self: flex-start; font-weight: 600; border-bottom-left-radius: 2px; box-shadow: 0 2px 10px rgba(255,184,28,0.2); }
        .suggestion-chip { background: rgba(255, 184, 28, 0.1); border: 1px solid rgba(255, 184, 28, 0.3); color: var(--gold); padding: 6px 12px; border-radius: 99px; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .suggestion-chip:hover { background: var(--gold); color: black; }

        /* REALISTIC COURT */
        .court-container svg { background-color: #dcb386; border: 2px solid #333; display: block; width: 100%; }
        .court-lines { fill: none; stroke: white; stroke-width: 0.17; vector-effect: non-scaling-stroke; }
        .paint-area { fill: #c04e01; fill-opacity: 0.3; }
        .hoop-rim { fill: none; stroke: #ff4500; stroke-width: 0.25; }
        .zone { cursor: pointer; transition: 0.2s; opacity: 0; fill: transparent; stroke: none; }
        .zone:hover { opacity: 0.5; fill: #FFB81C; stroke: white; stroke-width: 0.2; }

        /* MODALS & TOAST */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 50; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-content { background: #111; border: 1px solid var(--gold); padding: 20px; border-radius: 20px; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .toast-container { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 5px; width: 90%; max-width: 400px; }
        .toast { padding: 10px 16px; border-radius: 8px; color: white; font-weight: bold; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 8px; background: #222; border: 1px solid #444; animation: slideDown 0.2s; }
        .toast-success { border-left: 4px solid var(--green); } .toast-error { border-left: 4px solid var(--red); } .toast-persist { border-left: 4px solid var(--blue); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIG ---
        const ROSTER = [
            {id: 5, name: "Natasha Mistry", pos: "PG"}, {id: 3, name: "Mikayla Sanders", pos: "PG"}, 
            {id: 22, name: "Christina Lisack", pos: "PG/G"}, {id: 1, name: "Brittney Tang", pos: "G"},
            {id: 2, name: "Kylie Mulcahy", pos: "G"}, {id: 4, name: "Lexi Guild", pos: "G"},
            {id: 10, name: "Reese Jackson", pos: "F"}, {id: 32, name: "Gia Comey", pos: "F"}, 
            {id: 23, name: "Olivia Dozier", pos: "G/F"}, {id: 44, name: "Olivia Fraser", pos: "G/F"},
            {id: 34, name: "Dani Cardona", pos: "C"}, {id: 15, name: "Alexa Troiano", pos: "C"},
            {id: 0, name: "Bela Smith", pos: "C"} // FIXED: Changed pos to C
        ];
        const STAT_FIELDS = ['fg2m','fg2a','fg3m','fg3a','ftm','fta','reb','ast','stl','blk','to','pf'];
        const ZONES = ['top_3', 'wing_l_3', 'wing_r_3', 'corn_l_3', 'corn_r_3', 'mid_l_2', 'mid_r_2', 'paint'];
        const OPPONENT_ID = 'OPP';

        // --- HELPER HOOK FOR LOCAL STORAGE ---
        function useStickyState(defaultValue, key) {
            const [value, setValue] = React.useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            React.useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        }

        function App() {
            // STATE
            const [view, setView] = React.useState('live');
            const [games, setGames] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [db, setDb] = React.useState(null);
            const [toasts, setToasts] = React.useState([]);

            // STICKY DATA
            const [gameMeta, setGameMeta] = useStickyState({ date: new Date().toISOString().split('T')[0], opp: '', oppScore: 0, venue: 'Home', quarter: 1 }, 'eagles_meta');
            const [playerStats, setPlayerStats] = useStickyState({}, 'eagles_stats');
            const [opponentStats, setOpponentStats] = useStickyState({ fg2m:0, fg2a:0, fg3m:0, fg3a:0, ftm:0, fta:0 }, 'eagles_opp_stats');
            const [activeLineup, setActiveLineup] = useStickyState(ROSTER.slice(0, 5).map(p => p.id), 'eagles_lineup');
            const [playStats, setPlayStats] = useStickyState([
                { id: 'trans', name: 'TRANSITION', att: 0, made: 0, pts: 0 },
                { id: 'broken', name: 'BROKEN PLAY', att: 0, made: 0, pts: 0 },
                { id: 'motion', name: 'Motion Offense', att: 0, made: 0, pts: 0 }
            ], 'eagles_plays');
            const [eventLog, setEventLog] = useStickyState([], 'eagles_events');
            
            // GAME MANAGEMENT STATES
            const [timeouts, setTimeouts] = useStickyState({ full: [true,true,true], thirty: [true,true] }, 'eagles_timeouts');
            const [possession, setPossession] = useStickyState('home', 'eagles_possession');
            const [quarterFouls, setQuarterFouls] = useStickyState(0, 'eagles_q_fouls');
            
            // UI STATES
            const [newPlayName, setNewPlayName] = React.useState('');
            const [selectedPlayer, setSelectedPlayer] = React.useState(null); 
            const [subTarget, setSubTarget] = React.useState(null); 
            const [editId, setEditId] = React.useState(null);
            const [showSnapshot, setShowSnapshot] = React.useState(false);
            const [shotMode, setShotMode] = React.useState('make'); 
            
            // ANALYTICS & TACTICS STATE
            const [tacticsFilter, setTacticsFilter] = React.useState('season');
            const [selectedProfile, setSelectedProfile] = React.useState(ROSTER[0].name);
            const [sortConfig, setSortConfig] = React.useState({ key: 'ppg', direction: 'desc' });
            
            // AI
            const [chatHistory, setChatHistory] = React.useState([{role: 'bot', text: 'ü¶Ö Coach, I\'m ready. Ask me "Who is the MVP?", "Who takes the last shot?", or "Scout Reese".'}]);
            const [query, setQuery] = React.useState('');

            // --- INIT ---
            React.useEffect(() => {
                try {
                    const firebaseConfig = { apiKey: "AIzaSyA5H5SsumWG7bym_0EZ7jOlfWeswpSauhk", projectId: "eagles-stats", appId: "1:386723096734:web:b50e343c703983e838b38f" };
                    if(window.firebase && !firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                    const d = firebase.firestore();
                    setDb(d);
                    d.collection('games').orderBy('date', 'desc').onSnapshot(snap => {
                        setGames(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    });
                    if(Object.keys(playerStats).length > 0) showToast("Session Restored From Storage", "persist");
                } catch(e) { console.warn("Offline"); setLoading(false); }
            }, []);

            // --- TOAST SYSTEM ---
            const showToast = (msg, type='success') => {
                const id = Date.now();
                setToasts(p => [...p, {id, msg, type}]);
                setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 2500);
            };

            // --- GAME MANAGEMENT LOGIC ---
            const toggleTimeout = (type, index) => {
                setTimeouts(prev => ({ ...prev, [type]: prev[type].map((t, i) => i === index ? !t : t) }));
            };

            const togglePossession = () => setPossession(prev => prev === 'home' ? 'away' : 'home');

            const changeQuarter = (q) => {
                if(gameMeta.quarter === q) return;
                if(confirm(`Start Quarter ${q}? This will reset Team Fouls.`)) {
                    setGameMeta(prev => ({ ...prev, quarter: q }));
                    setQuarterFouls(0);
                    showToast(`Quarter ${q} Started. Fouls Reset.`, "info");
                }
            };

            // --- LIVE LOGIC ---
            const handleStatClick = (statKey, pointVal = 0) => {
                // FIXED: Changed !selectedPlayer to explicit null check to support ID 0
                if (selectedPlayer === null) return showToast("‚ö†Ô∏è Select a Player or Opponent First!", "error");

                const eventId = Date.now();
                const isMake = statKey.endsWith('m');
                const actionType = isMake ? 'MAKE' : (statKey.endsWith('a') ? 'MISS' : '');
                let shotType = '';
                if(statKey.includes('fg2')) shotType = '2PT';
                else if(statKey.includes('fg3')) shotType = '3PT';
                else if(statKey.includes('ft')) shotType = 'FT';
                else shotType = statKey.toUpperCase(); 
                
                const label = `${shotType} ${actionType}`.trim();
                const logItem = { id: eventId, stat: statKey, val: pointVal, type: 'player', pid: selectedPlayer, name: '', desc: label };

                // OPPONENT LOGIC
                if (selectedPlayer === OPPONENT_ID) {
                    const current = opponentStats[statKey] || 0;
                    let updates = { [statKey]: current + 1 };
                    if (statKey === 'fg2m') updates['fg2a'] = (opponentStats.fg2a || 0) + 1;
                    if (statKey === 'fg3m') updates['fg3a'] = (opponentStats.fg3a || 0) + 1;
                    if (statKey === 'ftm') updates['fta'] = (opponentStats.fta || 0) + 1;
                    setOpponentStats(prev => ({ ...prev, ...updates }));
                    if (pointVal > 0) setGameMeta(prev => ({ ...prev, oppScore: prev.oppScore + pointVal }));
                    logItem.type = 'opp'; logItem.name = 'Opponent'; logItem.desc = `${label} ${pointVal>0?`(+${pointVal})`:''}`;
                    setEventLog(prev => [logItem, ...prev].slice(0, 30)); 
                    showToast(`Opponent: ${label}`);
                    setSelectedPlayer(null);
                    return;
                }
                
                // PLAYER LOGIC
                const pName = ROSTER.find(r => r.id === selectedPlayer).name;
                const current = playerStats[pName]?.[statKey] || 0;
                let updates = { [statKey]: current + 1 };
                if (statKey === 'fg2m') updates['fg2a'] = (playerStats[pName]?.['fg2a'] || 0) + 1;
                if (statKey === 'fg3m') updates['fg3a'] = (playerStats[pName]?.['fg3a'] || 0) + 1;
                if (statKey === 'ftm') updates['fta'] = (playerStats[pName]?.['fta'] || 0) + 1;
                
                // Increment TEAM FOULS
                if (statKey === 'pf') setQuarterFouls(prev => prev + 1);

                setPlayerStats(prev => ({ ...prev, [pName]: { ...prev[pName], ...updates } }));
                logItem.name = pName.split(' ')[0]; logItem.desc = label;
                setEventLog(prev => [logItem, ...prev].slice(0, 30));
                showToast(`${logItem.name}: ${label} ${pointVal>0?`(+${pointVal})`:''}`);
                setSelectedPlayer(null); 
            };

            const handleUndo = (event) => {
                if(!confirm(`Undo ${event.name} ${event.desc}?`)) return;
                
                if (event.type === 'opp') {
                    setOpponentStats(prev => {
                        let u = { [event.stat]: Math.max(0, prev[event.stat] - 1) };
                        if (event.stat === 'fg2m') u['fg2a'] = Math.max(0, prev.fg2a - 1);
                        if (event.stat === 'fg3m') u['fg3a'] = Math.max(0, prev.fg3a - 1);
                        if (event.stat === 'ftm') u['fta'] = Math.max(0, prev.fta - 1);
                        return { ...prev, ...u };
                    });
                    if (event.val > 0) setGameMeta(prev => ({ ...prev, oppScore: Math.max(0, prev.oppScore - event.val) }));
                } else {
                    const pName = ROSTER.find(r => r.id === event.pid).name;
                    // Decrement Team Fouls if undoing a PF
                    if (event.stat === 'pf') setQuarterFouls(prev => Math.max(0, prev - 1));

                    setPlayerStats(prev => {
                        const pStats = prev[pName] || {};
                        let u = { [event.stat]: Math.max(0, (pStats[event.stat] || 0) - 1) };
                        if (event.stat === 'fg2m') u['fg2a'] = Math.max(0, (pStats.fg2a || 0) - 1);
                        if (event.stat === 'fg3m') u['fg3a'] = Math.max(0, (pStats.fg3a || 0) - 1);
                        if (event.stat === 'ftm') u['fta'] = Math.max(0, (pStats.fta || 0) - 1);
                        return { ...prev, [pName]: { ...prev[pName], ...u } };
                    });
                }
                setEventLog(prev => prev.filter(e => e.id !== event.id));
                showToast("Action Undone", "info");
            };

            const handleSubIn = (benchPid) => {
                // FIXED: Changed !subTarget to explicit null check to support ID 0
                if(subTarget === null) return;
                const newLineup = activeLineup.map(id => id === subTarget ? benchPid : id);
                setActiveLineup(newLineup);
                const pIn = ROSTER.find(r => r.id === benchPid).name;
                showToast(`üîÑ ${pIn.split(' ')[0]} Checked In`);
                setSubTarget(null);
            };

            const resetLiveGame = () => {
                if(!confirm("‚ö†Ô∏è RESET GAME?\n\nThis will wipe all current stats for this game. It cannot be undone.")) return;
                setPlayerStats({});
                setOpponentStats({fg2m:0,fg2a:0,fg3m:0,fg3a:0,ftm:0,fta:0});
                setGameMeta(prev => ({ ...prev, oppScore: 0, quarter: 1 }));
                setQuarterFouls(0);
                setTimeouts({ full: [true,true,true], thirty: [true,true] });
                setEventLog([]);
                showToast("Game Reset.", "info");
            };

            // --- AGGREGATION & ALERTS ---
            const getTeamScore = () => {
                let s = 0;
                Object.values(playerStats).forEach(st => { s += ((st.fg2m||0) * 2) + ((st.fg3m||0) * 3) + (st.ftm||0); });
                return s;
            };

            const getGameInsights = () => {
                let teamPF = 0, teamTO = 0, teamReb = 0;
                let alerts = [];
                let foulTrouble = [];
                let hotPlayers = [];
                let coldPlayers = [];

                Object.entries(playerStats).forEach(([name, s]) => {
                    teamPF += (s.pf || 0); teamTO += (s.to || 0); teamReb += (s.reb || 0);
                    
                    // Alerts logic - Updated to show EXACT count for >4 TOs
                    if((s.to || 0) >= 4) alerts.push({ msg: `‚ö†Ô∏è ${name.split(' ')[0]}: ${s.to} TOs`, type: 'bad' });
                    
                    if((s.pf || 0) >= 3) {
                        alerts.push({ msg: `‚ö†Ô∏è ${name.split(' ')[0]}: ${s.pf} Fouls`, type: 'warn' });
                        foulTrouble.push({ name: name.split(' ')[0], val: `${s.pf} Fouls` });
                    }
                    const fga = (s.fg2a || 0) + (s.fg3a || 0);
                    const fgm = (s.fg2m || 0) + (s.fg3m || 0);
                    if(fga >= 4) {
                        const pct = fgm / fga;
                        if(pct < 0.40) coldPlayers.push({ name: name.split(' ')[0], val: `${fgm}/${fga} (${Math.round(pct*100)}%)` });
                        if(pct > 0.75) hotPlayers.push({ name: name.split(' ')[0], val: `${fgm}/${fga} (${Math.round(pct*100)}%)` });
                    }
                    if((s.to || 0) >= 3) coldPlayers.push({ name: name.split(' ')[0], val: `${s.to} Turnovers` });
                });
                
                const teamFGM = Object.values(playerStats).reduce((a,s) => a + (s.fg2m||0) + (s.fg3m||0), 0);
                const teamFGA = Object.values(playerStats).reduce((a,s) => a + (s.fg2a||0) + (s.fg3a||0), 0);
                const team3PM = Object.values(playerStats).reduce((a,s) => a + (s.fg3m||0), 0);
                const team3PA = Object.values(playerStats).reduce((a,s) => a + (s.fg3a||0), 0);
                const teamFTM = Object.values(playerStats).reduce((a,s) => a + (s.ftm||0), 0);
                const teamFTA = Object.values(playerStats).reduce((a,s) => a + (s.fta||0), 0);
                
                const fgPct = teamFGA > 0 ? Math.round((teamFGM/teamFGA)*100) : 0;
                const fg3Pct = team3PA > 0 ? Math.round((team3PM/team3PA)*100) : 0;
                const ftPct = teamFTA > 0 ? Math.round((teamFTM/teamFTA)*100) : 0;
                
                return { teamPF, teamTO, teamReb, alerts, fgPct, fg3Pct, ftPct, teamFGM, teamFGA, teamFTM, teamFTA, foulTrouble, hotPlayers, coldPlayers };
            };

            const saveGame = async () => {
                if(!db) return showToast("Offline Mode", "error");
                const tScore = getTeamScore();
                const stats = ROSTER.map(p => { 
                    const s = playerStats[p.name] || {}; 
                    const pts = ((s.fg2m||0)*2)+((s.fg3m||0)*3)+(s.ftm||0);
                    return { ...p, ...s, pts }; 
                });
                const payload = { ...gameMeta, teamScore: tScore, stats, opponentStats, playStats, result: tScore > gameMeta.oppScore ? 'W' : 'L', updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
                try { 
                    if(editId) await db.collection('games').doc(editId).update(payload); 
                    else await db.collection('games').add(payload); 
                    showToast("Game Saved Successfully!", "success"); 
                    setPlayerStats({}); setOpponentStats({fg2m:0,fg2a:0,fg3m:0,fg3a:0,ftm:0,fta:0}); setEventLog([]); setQuarterFouls(0); setTimeouts({ full: [true,true,true], thirty: [true,true] });
                    setGameMeta({ date: new Date().toISOString().split('T')[0], opp: '', oppScore: 0, venue: 'Home', quarter: 1 }); setEditId(null); setView('log'); 
                } 
                catch(e) { showToast("Error Saving: " + e.message, "error"); }
            };

            // --- DATA PROCESSORS ---
            const updatePlayerStat = (player, field, value) => { const safeVal = Math.max(0, parseInt(value) || 0); const currentStats = playerStats[player] || {}; let updates = { [field]: safeVal }; if (field.endsWith('m')) { const attKey = field.replace('m', 'a'); if (safeVal > (currentStats[attKey] || 0)) updates[attKey] = safeVal; } else if (field.endsWith('a')) { const makeKey = field.replace('a', 'm'); if (safeVal < (currentStats[makeKey] || 0)) updates[makeKey] = safeVal; } setPlayerStats(prev => ({ ...prev, [player]: { ...prev[player], ...updates } })); };
            const getSeasonStats = () => { const totals = {}; ROSTER.forEach(p => totals[p.name] = { name: p.name, pos: p.pos, games: 0, pts:0, reb:0, ast:0, stl:0, blk:0, to:0, fg2m:0, fg2a:0, fg3m:0, fg3a:0, ftm:0, fta:0 }); games.forEach(g => g.stats.forEach(s => { if (totals[s.name]) { const t = totals[s.name]; t.games++; t.fg2m+=(s.fg2m||0); t.fg2a+=(s.fg2a||0); t.fg3m+=(s.fg3m||0); t.fg3a+=(s.fg3a||0); t.ftm+=(s.ftm||0); t.fta+=(s.fta||0); t.reb+=(s.reb||0); t.ast+=(s.ast||0); t.stl+=(s.stl||0); t.blk+=(s.blk||0); t.to+=(s.to||0); t.pts+=((s.fg2m||0)*2+(s.fg3m||0)*3+(s.ftm||0)); } })); return Object.values(totals).map(t => { const g = t.games || 1; const totalFGM = t.fg2m + t.fg3m; const totalFGA = t.fg2a + t.fg3a; const eFG = totalFGA > 0 ? ((totalFGM + (0.5 * t.fg3m)) / totalFGA) * 100 : 0; const tsDiv = 2 * (totalFGA + (0.44 * t.fta)); const TS = tsDiv > 0 ? (t.pts / tsDiv) * 100 : 0; return { ...t, ppg:(t.pts/g).toFixed(1), rpg:(t.reb/g).toFixed(1), apg:(t.ast/g).toFixed(1), spg:(t.stl/g).toFixed(1), bpg:(t.blk/g).toFixed(1), topg:(t.to/g).toFixed(1), fgPct:totalFGA>0?Math.round((totalFGM/totalFGA)*100):0, fg3Pct:t.fg3a>0?Math.round((t.fg3m/t.fg3a)*100):0, ftPct:t.fta>0?Math.round((t.ftm/t.fta)*100):0, eFG: Math.round(eFG), TS: Math.round(TS), to:t.to, ast:t.ast }; }).sort((a,b) => { const aVal = parseFloat(a[sortConfig.key])||0, bVal = parseFloat(b[sortConfig.key])||0; return sortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal; }); };
            const getClipboardData = () => { const totalGames = games.length || 1; const totals = { pts:0, opp:0, reb:0, ast:0, to:0, stocks:0 }; const pMap = {}; ROSTER.forEach(p => pMap[p.name] = { name: p.name, gp:0, pts:0, reb:0, fg3m:0, fg3a:0, ftm:0, fta:0, highs:{pts:0,ast:0,reb:0,stl:0,blk:0} }); let seasonHighs = { pts:{val:0}, ast:{val:0}, reb:{val:0}, stl:{val:0}, blk:{val:0} }; games.forEach(g => { totals.pts += g.teamScore || 0; totals.opp += g.oppScore || 0; g.stats.forEach(s => { totals.reb += (s.reb||0); totals.ast += (s.ast||0); totals.to += (s.to||0); totals.stocks += ((s.stl||0) + (s.blk||0)); if(pMap[s.name]) { const p = pMap[s.name]; p.gp++; const pts = ((s.fg2m||0)*2)+((s.fg3m||0)*3)+(s.ftm||0); p.pts += pts; p.reb += (s.reb||0); p.fg3m += (s.fg3m||0); p.fg3a += (s.fg3a||0); p.ftm += (s.ftm||0); p.fta += (s.fta||0); if(pts > seasonHighs.pts.val) seasonHighs.pts = {val:pts, player:s.name}; if((s.reb||0) > seasonHighs.reb.val) seasonHighs.reb = {val:s.reb, player:s.name}; if((s.ast||0) > seasonHighs.ast.val) seasonHighs.ast = {val:s.ast, player:s.name}; if((s.stl||0) > seasonHighs.stl.val) seasonHighs.stl = {val:s.stl, player:s.name}; if((s.blk||0) > seasonHighs.blk.val) seasonHighs.blk = {val:s.blk, player:s.name}; } }); }); const players = Object.values(pMap).filter(p => p.gp > 0); return { team: { ppg:(totals.pts/totalGames).toFixed(1), opp:(totals.opp/totalGames).toFixed(1), rpg:(totals.reb/totalGames).toFixed(1), apg:(totals.ast/totalGames).toFixed(1), topg:(totals.to/totalGames).toFixed(1), stocks:(totals.stocks/totalGames).toFixed(1), record:`${games.filter(g=>g.result==='W').length}-${games.filter(g=>g.result==='L').length}` }, scorers: [...players].sort((a,b)=>(b.pts/b.gp)-(a.pts/a.gp)).slice(0,3), rebounders: [...players].sort((a,b)=>(b.reb/b.gp)-(a.reb/a.gp)).slice(0,3), snipers: [...players].filter(p=>p.fg3a>5).sort((a,b)=>(b.fg3m/b.fg3a)-(a.fg3m/a.fg3a)).slice(0,3), freeThrowers: [...players].filter(p=>p.fta>5).sort((a,b)=>(b.ftm/b.fta)-(a.ftm/a.fta)).slice(0,3), seasonHighs }; };
            const getPlayerData = (pName) => { const pGames = games.filter(g => (g.stats || []).find(s => s.name === pName)); const totals = { gp: pGames.length, pts:0, reb:0, ast:0, stl:0, blk:0, to:0, fg2m:0, fg2a:0, fg3m:0, fg3a:0, ftm:0, fta:0 }; const highs = { pts:0, reb:0, ast:0, stl:0, blk:0 }; pGames.forEach(g => { const s = g.stats.find(stat => stat.name === pName); const pts = ((s.fg2m||0)*2)+((s.fg3m||0)*3)+(s.ftm||0); totals.pts+=pts; totals.reb+=(s.reb||0); totals.ast+=(s.ast||0); totals.stl+=(s.stl||0); totals.blk+=(s.blk||0); totals.to+=(s.to||0); totals.fg2m+=(s.fg2m||0); totals.fg2a+=(s.fg2a||0); totals.fg3m+=(s.fg3m||0); totals.fg3a+=(s.fg3a||0); totals.ftm+=(s.ftm||0); totals.fta+=(s.fta||0); if(pts>highs.pts) highs.pts=pts; if((s.reb||0)>highs.reb) highs.reb=s.reb; if((s.ast||0)>highs.ast) highs.ast=s.ast; if((s.stl||0)>highs.stl) highs.stl=s.stl; if((s.blk||0)>highs.blk) highs.blk=s.blk; }); const gp = totals.gp || 1; const totalFGM = totals.fg2m + totals.fg3m; const totalFGA = totals.fg2a + totals.fg3a; const eFG = totalFGA > 0 ? ((totalFGM + (0.5 * totals.fg3m)) / totalFGA) * 100 : 0; const tsDiv = 2 * (totalFGA + (0.44 * totals.fta)); const TS = tsDiv > 0 ? (totals.pts / tsDiv) * 100 : 0; return { totals, highs, games: pGames, avgs: { ppg:(totals.pts/gp).toFixed(1), rpg:(totals.reb/gp).toFixed(1), apg:(totals.ast/gp).toFixed(1), spg:(totals.stl/gp).toFixed(1), bpg:(totals.blk/gp).toFixed(1), topg:(totals.to/gp).toFixed(1) }, pcts: { fg:totalFGA>0?Math.round((totalFGM/totalFGA)*100):0, fg2:totals.fg2a>0?Math.round((totals.fg2m/totals.fg2a)*100):0, fg3:totals.fg3a>0?Math.round((totals.fg3m/totals.fg3a)*100):0, ft:totals.fta>0?Math.round((totals.ftm/totals.fta)*100):0, eFG: Math.round(eFG), TS: Math.round(TS) } }; };
            const getTacticalData = () => { let targetGames = tacticsFilter === 'season' ? games : games.filter(g => g.id === tacticsFilter); const aggPlays = {}; const aggMap = ZONES.reduce((a,z)=>({...a,[z]:{m:0,x:0}}), {}); targetGames.forEach(g => { if(g.playStats) g.playStats.forEach(p => { if(!aggPlays[p.name]) aggPlays[p.name] = { name: p.name, att: 0, made: 0, pts: 0 }; aggPlays[p.name].att += (p.att || 0); aggPlays[p.name].made += (p.made || 0); aggPlays[p.name].pts += (p.pts || (p.made*2) || 0); }); if(g.shotMap && g.shotMap.eagles) ZONES.forEach(z => { const zone = g.shotMap.eagles[z] || {m:0, x:0}; aggMap[z].m += zone.m; aggMap[z].x += zone.x; }); }); return { plays: Object.values(aggPlays), map: aggMap }; };
            
            const getTrendSummaries = () => {
                if(games.length < 2) return [];
                const sorted = [...games].sort((a,b) => new Date(b.date) - new Date(a.date));
                const last3 = sorted.slice(0, 3);
                const seasonStats = getSeasonStats();
                let summaries = [];
                // Scoring
                const avgLast3 = last3.reduce((a,g)=>a+(g.teamScore||0),0)/last3.length;
                const avgSeasonGames = sorted.reduce((a,g)=>a+(g.teamScore||0),0)/sorted.length;
                const diffScore = avgLast3 - avgSeasonGames;
                if(diffScore > 5) summaries.push({ title: "üî• Hot Offense", desc: `Scoring +${diffScore.toFixed(1)} PPG recently.`, type: "good" });
                else if(diffScore < -5) summaries.push({ title: "‚ùÑÔ∏è Scoring Slump", desc: `Offense is down ${Math.abs(diffScore).toFixed(1)} PPG.`, type: "bad" });
                // Turnovers
                const toLast3 = last3.reduce((a,g)=>a + (g.stats||[]).reduce((x,s)=>x+(s.to||0),0),0)/last3.length;
                if(toLast3 > 15) summaries.push({ title: "‚ö†Ô∏è Ball Security", desc: `Averaging ${toLast3.toFixed(1)} TOs in last 3 games.`, type: "bad" });
                else if(toLast3 < 10) summaries.push({ title: "üîí Safe Hands", desc: `Only ${toLast3.toFixed(1)} turnovers/game recently.`, type: "good" });
                return summaries;
            };

            // --- AI ---
            const handleSearch = (e, manualQuery) => {
                if(e) e.preventDefault();
                const qText = manualQuery || query;
                if(!qText.trim()) return;
                const userQ = qText.toLowerCase();
                const newHistory = [...chatHistory, {role: 'user', text: qText}];
                setQuery('');
                let response = "I didn't quite catch that. Check the 'Capabilities' box.";
                const stats = getSeasonStats();
                if(stats.length === 0) { setChatHistory([...newHistory, {role: 'bot', text: "I need more game data before I can answer that, Coach!"}]); return; }
                const getImpact = (p) => (parseFloat(p.ppg)*1) + (parseFloat(p.rpg)*1.5) + (parseFloat(p.apg)*1.5) + (parseFloat(p.spg)*3) + (parseFloat(p.bpg)*3) - (parseFloat(p.topg)*2);
                if (userQ.includes('best player') || userQ.includes('mvp')) { const sorted = [...stats].sort((a,b) => getImpact(b) - getImpact(a)); response = sorted.length > 0 ? `üèÜ MVP: ${sorted[0].name}\nImpact Rating: ${getImpact(sorted[0]).toFixed(1)}` : "Not enough data."; }
                else { const playerFound = ROSTER.find(p => userQ.includes(p.name.toLowerCase())); if(playerFound) { const s = stats.find(x => x.name === playerFound.name); if(s) response = `‚ÑπÔ∏è ${playerFound.name}: ${s.ppg} PPG, ${s.rpg} RPG.`; else response = "No stats yet."; } }
                setChatHistory([...newHistory, {role: 'bot', text: response}]);
            };

            const handlePlayUpdate = (index, points) => { const newPlays = [...playStats]; newPlays[index].att += 1; if (points > 0) { newPlays[index].made += 1; newPlays[index].pts += points; } setPlayStats(newPlays); };
            const handleSort = (key) => { setSortConfig({ key, direction: sortConfig.key === key && sortConfig.direction === 'desc' ? 'asc' : 'desc' }); };
            const exportData = () => { if(!games.length) return showToast("No data.", "error"); const headers = ['date', 'opp', 'teamScore', 'oppScore', 'result', 'venue', 'stats', 'playStats']; const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...games.map(g => headers.map(h => { let val = g[h]; if (typeof val === 'object') { val = JSON.stringify(val).replace(/"/g, '""'); return `"${val}"`; } return `"${val}"`; }).join(','))].join('\n'); const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `eagles_backup_${new Date().toISOString().split('T')[0]}.csv`); document.body.appendChild(link); link.click(); };
            const importData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const rows = event.target.result.split('\n'); const headers = rows[0].split(','); let importedCount = 0; const parseCSVRow = (row) => { const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g; const matches = []; let match; while(match = regex.exec(row)) { let val = match[1]; if(val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length-1).replace(/""/g, '"'); matches.push(val); } return matches; }; for (let i = 1; i < rows.length; i++) { if (!rows[i].trim()) continue; const vals = parseCSVRow(rows[i]); const payload = {}; headers.forEach((h, index) => { const key = h.trim(); let val = vals[index]; if (['stats','opponentStats','playStats'].includes(key)) try { val = JSON.parse(val); } catch(e) { val = []; } if(['teamScore','oppScore'].includes(key)) val = parseInt(val) || 0; payload[key] = val; }); payload.updatedAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection('games').add(payload); importedCount++; } showToast(`Restored ${importedCount} games!`, "success"); } catch (err) { showToast("Error importing CSV", "error"); } }; reader.readAsText(file); };
            const purgeData = async () => { if(!confirm("‚ö†Ô∏è DELETE ALL GAMES?")) return; const snap = await db.collection('games').get(); const batch = db.batch(); snap.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); showToast("Purged.", "success"); };

            if(loading) return <div className="p-20 text-center text-gold font-bold">LOADING DATA...</div>;

            const clipboard = getClipboardData();
            const seasonStats = getSeasonStats();
            const tactics = getTacticalData();
            const profile = getPlayerData(selectedProfile);
            const playerInfo = ROSTER.find(p => p.name === selectedProfile);
            const activePlayers = ROSTER.filter(p => activeLineup.includes(p.id));
            const benchPlayers = ROSTER.filter(p => !activeLineup.includes(p.id));
            
            // INSIGHTS & TRENDS
            const insights = getGameInsights();
            const trendSummaries = getTrendSummaries();

            return (
                <div className="pb-24 max-w-7xl mx-auto p-4">
                    <div className="toast-container">{toasts.map(t => <div key={t.id} className={`toast toast-${t.type}`}>{t.msg}</div>)}</div>

                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 bg-zinc-900 p-4 rounded-xl border border-white/10 sticky top-2 z-50 shadow-xl no-print">
                        <div className="flex items-center gap-2 mb-4 md:mb-0"><span className="text-2xl">ü¶Ö</span><h1 className="text-xl font-black italic uppercase">Eagles <span className="text-gold">Analytics</span></h1></div>
                        <nav className="flex gap-1 overflow-x-auto w-full md:w-auto pb-1 no-scrollbar">
                            {['live', 'new', 'clipboard', 'ask coach', 'trends', 'stats', 'profiles', 'log', 'admin'].map(t => (<button key={t} onClick={()=>setView(t)} className={`nav-btn ${view===t?'active-nav':'inactive-nav'}`}>{t}</button>))}
                        </nav>
                    </div>

                    {/* LIVE VIEW */}
                    {view === 'live' && (
                        <div className="flex flex-col h-[85vh] overflow-hidden">
                            <div className="live-header">
                                <div className="score-box"><div className="score-label">EAGLES</div><div className="score-val text-gold">{getTeamScore()}</div>
                                    <div className="timeout-pills">
                                        {[...Array(3)].map((_,i)=><div key={`f-${i}`} onClick={()=>toggleTimeout('full',i)} className={`to-pill ${timeouts.full[i]?'active':'used'}`}>F</div>)}
                                        {[...Array(2)].map((_,i)=><div key={`30-${i}`} onClick={()=>toggleTimeout('thirty',i)} className={`to-pill ${timeouts.thirty[i]?'active':'used'}`}>30</div>)}
                                    </div>
                                </div>
                                <div className="flex flex-col items-center gap-1"><div onClick={togglePossession} className="poss-arrow text-white">{possession==='home'?'‚¨ÖÔ∏è':'‚û°Ô∏è'}</div><div className="text-zinc-600 font-black text-xs">POSS</div></div>
                                <div className="score-box"><div className="flex justify-center gap-1 mb-1"><div onClick={()=>setGameMeta(p=>({...p, oppScore: Math.max(0, p.oppScore-1)}))} className="cursor-pointer text-zinc-500 hover:text-white">-</div><div className="score-val text-white">{gameMeta.oppScore}</div><div onClick={()=>setGameMeta(p=>({...p, oppScore: p.oppScore+1}))} className="cursor-pointer text-zinc-500 hover:text-white">+</div></div><input value={gameMeta.opp} onChange={e=>setGameMeta({...gameMeta, opp:e.target.value})} className="bg-transparent border-0 text-center score-label w-full outline-none placeholder-zinc-700" placeholder="OPPONENT"/></div>
                            </div>
                            
                            {/* COACH HUD */}
                            <div className="coach-hud">
                                <div className="q-selector">{[1,2,3,4].map(q=><button key={q} onClick={()=>changeQuarter(q)} className={`q-btn ${gameMeta.quarter===q?'active':''}`}>Q{q}</button>)}</div>
                                <div className="hud-box"><div className="hud-label">TEAM FOULS</div><div className={`hud-val ${quarterFouls>=5?'text-red-500':'text-white'}`}>{quarterFouls}</div>{quarterFouls>=5 && <div className="bonus-badge">BONUS</div>}</div>
                                <div className="hud-box"><div className="hud-label">FG%</div><div className={`hud-val ${insights.fgPct>=45?'text-green-500':(insights.fgPct<30?'text-red-500':'text-white')}`}>{insights.fgPct}%</div></div>
                                <div className="hud-box"><div className="hud-label">TO</div><div className={`hud-val ${insights.teamTO>=12?'text-red-500':'text-white'}`}>{insights.teamTO}</div></div>
                                <button onClick={()=>setShowSnapshot(true)} className="bg-blue-600 text-white text-[10px] font-black uppercase p-2 rounded h-full">üìä SNAPSHOT</button>
                            </div>
                            
                            {insights.alerts.length > 0 && (
                                <div className="alert-ticker">{insights.alerts.map((a,i) => <div key={i} className={`live-alert ${a.type}`}>{a.msg}</div>)}</div>
                            )}
                            
                            <div className="p-2 flex-1 flex gap-2 overflow-hidden">
                                <div className="w-1/3 flex flex-col gap-2 h-full overflow-y-auto pr-1 custom-scrollbar">
                                    {activePlayers.map(p => {
                                        const isSelected = selectedPlayer === p.id;
                                        const s = playerStats[p.name] || {};
                                        const pts = ((s.fg2m||0)*2)+((s.fg3m||0)*3)+(s.ftm||0);
                                        return (
                                            <div key={p.id} onClick={() => setSelectedPlayer(p.id)} className={`kb-player-btn ${isSelected ? 'selected' : ''}`}>
                                                <button onClick={(e)=>{e.stopPropagation(); setSubTarget(p.id)}} className="sub-icon">üîÑ</button>
                                                <div className="text-lg font-black leading-none">{p.name.split(' ')[0]}</div>
                                                <div className={`text-[10px] font-bold ${isSelected ? 'text-black' : 'text-zinc-500'}`}>#{p.id} ‚Ä¢ {pts} Pts</div>
                                                {s.pf > 0 && <div className="absolute bottom-1 left-2 text-[9px] font-bold text-red-500">{s.pf} PF</div>}
                                            </div>
                                        )
                                    })}
                                    <div onClick={() => setSelectedPlayer(OPPONENT_ID)} className={`kb-player-btn kb-opp-btn ${selectedPlayer === OPPONENT_ID ? 'selected' : ''}`}>
                                        <div className="text-xl font-black italic tracking-widest">OPPONENT</div>
                                        <div className="text-[10px] opacity-70">Track Scoring</div>
                                    </div>
                                    
                                    {/* LIVE EVENT FEED (UNDO LIST) */}
                                    <div className="event-feed">
                                        {eventLog.length === 0 && <div className="text-zinc-600 text-xs text-center italic">No actions yet</div>}
                                        {eventLog.map(ev => (
                                            <div key={ev.id} onClick={() => handleUndo(ev)} className="event-item">
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-white">{ev.name}</span>
                                                    <span className="text-zinc-400">{ev.desc}</span>
                                                </div>
                                                <span className="undo-hint">UNDO</span>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    <button onClick={saveGame} className="mt-auto w-full py-4 bg-blue-700 hover:bg-blue-600 rounded font-black uppercase text-xs">SAVE GAME</button>
                                    <button onClick={resetLiveGame} className="mt-2 w-full py-3 bg-zinc-900 text-red-500 font-bold text-xs rounded hover:bg-red-900/20">RESET / CLEAR GAME</button>
                                </div>
                                <div className="w-2/3 h-full flex flex-col gap-2">
                                    {selectedPlayer === OPPONENT_ID ? (
                                        <>
                                            <div className="h-10 flex items-center justify-center text-red-400 font-bold uppercase text-xs border-b border-red-900/30">TRACKING OPPONENT SCORING</div>
                                            <div className="flex gap-2 flex-1"><button onClick={() => handleStatClick('fg2m', 2)} className="kb-stat-btn bg-make text-xl">Opp 2PT (+2)</button><button onClick={() => handleStatClick('fg2a')} className="kb-stat-btn bg-miss text-xl">Opp 2PT Miss</button></div>
                                            <div className="flex gap-2 flex-1"><button onClick={() => handleStatClick('fg3m', 3)} className="kb-stat-btn bg-make text-xl">Opp 3PT (+3)</button><button onClick={() => handleStatClick('fg3a')} className="kb-stat-btn bg-miss text-xl">Opp 3PT Miss</button></div>
                                            <div className="flex gap-2 flex-1"><button onClick={() => handleStatClick('ftm', 1)} className="kb-stat-btn bg-make text-xl">Opp FT (+1)</button><button onClick={() => handleStatClick('fta')} className="kb-stat-btn bg-miss text-xl">Opp FT Miss</button></div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="flex gap-2 h-1/5"><button onClick={() => handleStatClick('fg2m', 2)} className="kb-stat-btn bg-make">2PT MAKE (+2)</button><button onClick={() => handleStatClick('fg2a')} className="kb-stat-btn bg-miss">2PT MISS</button></div>
                                            <div className="flex gap-2 h-1/5"><button onClick={() => handleStatClick('fg3m', 3)} className="kb-stat-btn bg-make">3PT MAKE (+3)</button><button onClick={() => handleStatClick('fg3a')} className="kb-stat-btn bg-miss">3PT MISS</button></div>
                                            <div className="flex gap-2 h-1/5"><button onClick={() => handleStatClick('ftm', 1)} className="kb-stat-btn bg-make">FT MAKE (+1)</button><button onClick={() => handleStatClick('fta')} className="kb-stat-btn bg-miss">FT MISS</button></div>
                                            <div className="flex gap-2 h-1/5"><button onClick={() => handleStatClick('reb')} className="kb-stat-btn bg-action">REBOUND</button><button onClick={() => handleStatClick('ast')} className="kb-stat-btn bg-action">ASSIST</button><button onClick={() => handleStatClick('stl')} className="kb-stat-btn bg-action">STEAL</button></div>
                                            <div className="flex gap-2 h-1/5"><button onClick={() => handleStatClick('blk')} className="kb-stat-btn bg-action">BLOCK</button><button onClick={() => handleStatClick('to')} className="kb-stat-btn bg-neg">TURNOVER</button><button onClick={() => handleStatClick('pf')} className="kb-stat-btn bg-neg">FOUL</button></div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* NEW / EDIT VIEW (TABLE) */}
                    {view === 'new' && (
                        <div className="space-y-6">
                            <div className="bento-card grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="space-y-1"><label className="text-[9px] font-bold text-zinc-500 uppercase">Opponent</label><input className="w-full bg-black border border-zinc-700 p-2 rounded text-white font-bold" value={gameMeta.opp} onChange={e=>setGameMeta({...gameMeta, opp:e.target.value})} placeholder="Required..." /></div>
                                <div className="space-y-1"><label className="text-[9px] font-bold text-zinc-500 uppercase">Opp Score</label><input type="number" className="w-full bg-black border border-zinc-700 p-2 rounded text-white font-bold" value={gameMeta.oppScore} onChange={e=>setGameMeta({...gameMeta, oppScore:parseInt(e.target.value)||0})} /></div>
                                <div className="space-y-1"><label className="text-[9px] font-bold text-zinc-500 uppercase">Date</label><input type="date" className="w-full bg-black border border-zinc-700 p-2 rounded text-white font-bold" value={gameMeta.date} onChange={e=>setGameMeta({...gameMeta, date:e.target.value})} /></div>
                                <div className="space-y-1"><label className="text-[9px] font-bold text-zinc-500 uppercase">Venue</label><select className="w-full bg-black border border-zinc-700 p-2 rounded text-white font-bold" value={gameMeta.venue} onChange={e=>setGameMeta({...gameMeta, venue:e.target.value})}><option>Home</option><option>Away</option></select></div>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                <div className="lg:col-span-4 bento-card border-t-4 border-gold">
                                    <h3 className="font-black text-gold uppercase mb-4">Playbook</h3>
                                    <div className="space-y-2">{playStats.map((p,i)=>(<div key={i} className="flex items-center gap-2 p-2 border-b border-white/5"><div className="flex-1 font-bold text-xs uppercase">{p.name}</div><button onClick={()=>handlePlayUpdate(i,0)} className="px-2 py-1 bg-zinc-800 rounded text-[10px] hover:bg-red-900/50">Stop</button><button onClick={()=>handlePlayUpdate(i,2)} className="px-2 py-1 bg-zinc-800 rounded text-[10px] hover:bg-blue-900/50">+2</button><button onClick={()=>handlePlayUpdate(i,3)} className="px-2 py-1 bg-zinc-800 rounded text-[10px] hover:bg-green-900/50">+3</button></div>))}</div>
                                    <div className="flex gap-2 mt-4"><input className="bg-black border border-zinc-700 rounded p-2 text-xs flex-1 text-white font-bold" placeholder="New Play..." value={newPlayName} onChange={e=>setNewPlayName(e.target.value)} /><button onClick={()=>{if(newPlayName){setPlayStats([...playStats,{id:Date.now(),name:newPlayName,att:0,made:0,pts:0}]);setNewPlayName('');}}} className="bg-gold text-black font-bold text-xs px-3 rounded uppercase">Add</button></div>
                                </div>
                                <div className="lg:col-span-8 bento-card">
                                    <h3 className="font-black text-gold uppercase mb-4">Stat Correction Table</h3>
                                    <div className="overflow-x-auto"><table className="w-full text-xs"><thead><tr className="text-zinc-500 border-b border-zinc-800"><th className="p-2 text-left">PLAYER</th>{STAT_FIELDS.map(f=><th key={f} className="p-1 uppercase text-center">{f.replace('fg','').replace('m','')}</th>)}</tr></thead><tbody>{ROSTER.map(p=>{const s=playerStats[p.name]||{};return(<tr key={p.id} className="border-b border-white/5"><td className="p-2 font-bold whitespace-nowrap">{p.name}</td>{STAT_FIELDS.map(f=><td key={f} className="p-1"><div className="flex items-center gap-1"><button onClick={() => updatePlayerStat(p.name, f, (s[f]||0) - 1)} className="stepper-btn hover:bg-red-900/50 hover:text-red-200">-</button><input type="number" className="stat-input text-center bg-transparent border-0 p-0" value={s[f]||0} readOnly /><button onClick={() => updatePlayerStat(p.name, f, (s[f]||0) + 1)} className="stepper-btn hover:bg-green-900/50 hover:text-green-200">+</button></div></td>)}</tr>)})}</tbody></table></div>
                                </div>
                            </div>
                            <button onClick={saveGame} className="w-full py-4 bg-gold hover:bg-white text-black font-black uppercase text-xl rounded-xl shadow-lg transition-all">Save Game</button>
                        </div>
                    )}

                    {view === 'clipboard' && (
                        <div className="space-y-6 animate-slideIn">
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3"><MiniStat label="Record" value={clipboard.team.record} /><MiniStat label="PPG" value={clipboard.team.ppg} color="text-gold" /><MiniStat label="Opp PPG" value={clipboard.team.opp} color="text-red-400" /><MiniStat label="RPG" value={clipboard.team.rpg} /><MiniStat label="APG" value={clipboard.team.apg} /><MiniStat label="Stocks" value={clipboard.team.stocks} sub="(Stl+Blk)" /><MiniStat label="TO/G" value={clipboard.team.topg} color="text-zinc-400" /></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><Leaderboard title="Scoring Leaders" icon="üî•" players={clipboard.scorers} valFunc={p=>(p.pts/p.gp).toFixed(1)} label="PPG" /><Leaderboard title="Glass Cleaners" icon="üí™" players={clipboard.rebounders} valFunc={p=>(p.reb/p.gp).toFixed(1)} label="RPG" /><Leaderboard title="Snipers (3PT%)" icon="üéØ" players={clipboard.snipers} valFunc={p=>Math.round((p.fg3m/p.fg3a)*100)+'%'} label="3PT%" /><Leaderboard title="Free Throws" icon="üîí" players={clipboard.freeThrowers} valFunc={p=>Math.round((p.ftm/p.fta)*100)+'%'} label="FT%" /></div>
                            <div className="bento-card border-t-4 border-gold"><h3 className="text-sm font-black text-zinc-500 uppercase tracking-widest mb-4">üèÜ Season Honor Roll</h3><div className="grid grid-cols-2 md:grid-cols-5 gap-4"><HonorCard label="Pts" data={clipboard.seasonHighs.pts} color="text-white" /><HonorCard label="Ast" data={clipboard.seasonHighs.ast} color="text-blue-400" /><HonorCard label="Reb" data={clipboard.seasonHighs.reb} color="text-green-400" /><HonorCard label="Stl" data={clipboard.seasonHighs.stl} color="text-gold" /><HonorCard label="Blk" data={clipboard.seasonHighs.blk} color="text-red-400" /></div></div>
                        </div>
                    )}

                    {view === 'ask coach' && (
                        <div className="animate-slideIn max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-2 bento-card h-[65vh] flex flex-col">
                                <div className="flex-1 overflow-y-auto mb-4 space-y-4 p-2 custom-scrollbar">{chatHistory.map((msg, i) => (<div key={i} className={`chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-bot'}`}>{msg.text}</div>))}</div>
                                <div className="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar">{["üèÜ Who is MVP?", "üèÄ Clutch Player", "üõ°Ô∏è Defensive Stop", "üß† Best Playmaker", "üìâ Scout Reese"].map(q => (<button key={q} onClick={(e)=>handleSearch(e, q)} className="suggestion-chip">{q}</button>))}</div>
                                <form onSubmit={handleSearch} className="flex gap-2"><input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Type your question..." className="flex-1 bg-black border border-zinc-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-gold" /><button type="submit" className="bg-gold text-black font-bold px-6 py-3 rounded-lg hover:bg-white transition">SEND</button></form>
                            </div>
                            <div className="bento-card h-full overflow-y-auto"><h3 className="text-xl font-black text-gold uppercase italic mb-4">Coach's Playbook</h3><div className="space-y-4 text-xs"><div><div className="font-bold text-green-400 mb-1">‚úÖ TRY ASKING:</div><ul className="space-y-2 text-zinc-400"><li>‚Ä¢ "Who is the MVP?" (Impact Rating)</li><li>‚Ä¢ "Who takes the last shot?" (Clutch)</li><li>‚Ä¢ "I need a defensive stop."</li><li>‚Ä¢ "Who should handle the ball?"</li><li>‚Ä¢ "Compare Reese and Natasha."</li><li>‚Ä¢ "Scout Kylie." (Full Report)</li></ul></div></div></div>
                        </div>
                    )}

                    {view === 'tactics' && (
                        <div className="space-y-6 animate-slideIn">
                            <div className="flex justify-between items-center bg-zinc-900 p-3 rounded-lg border border-zinc-800"><label className="text-xs font-bold text-zinc-500 uppercase mr-3">Data Source:</label><select className="bg-black text-white font-bold text-xs p-2 rounded border border-zinc-700 flex-1" value={tacticsFilter} onChange={e=>setTacticsFilter(e.target.value)}><option value="season">FULL SEASON AGGREGATE</option><optgroup label="Single Games">{games.map(g => <option key={g.id} value={g.id}>{g.date} vs {g.opp}</option>)}</optgroup></select></div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bento-card h-full"><h3 className="text-xl font-black text-gold uppercase italic mb-4">Set Play Efficiency</h3><div className="space-y-1">{tactics.plays.sort((a,b)=>((b.pts/b.att)||-1)-((a.pts/a.att)||-1)).map((p,i)=>(<div key={i} className="flex justify-between p-3 bg-zinc-900/50 rounded items-center"><span className="font-bold text-sm">{p.name}</span><div className="text-right"><div className="font-black text-gold text-lg">{(p.att>0?p.pts/p.att:0).toFixed(2)} PPP</div><div className="text-[10px] text-zinc-500">{p.made}/{p.att} ({p.att>0?Math.round((p.made/p.att)*100):0}%)</div></div></div>))}</div></div>
                                <div className="bento-card"><h3 className="text-xl font-black text-gold uppercase italic mb-6">Shot Efficiency</h3><ShotEfficiencyMap data={tactics.map} /></div>
                            </div>
                        </div>
                    )}

                    {view === 'stats' && (
                        <div className="bento-card overflow-hidden animate-slideIn">
                             <div className="overflow-x-auto"><table className="w-full text-left border-collapse stat-table"><thead><tr><th onClick={()=>handleSort('name')}>Player</th><th onClick={()=>handleSort('ppg')} className="text-gold">PPG</th><th onClick={()=>handleSort('rpg')}>RPG</th><th onClick={()=>handleSort('apg')}>APG</th><th onClick={()=>handleSort('spg')}>SPG</th><th onClick={()=>handleSort('bpg')}>BPG</th><th onClick={()=>handleSort('topg')} className="text-red-400">TO</th><th onClick={()=>handleSort('fgPct')}>FG%</th><th onClick={()=>handleSort('eFG')} className="text-blue-400">eFG%</th><th onClick={()=>handleSort('TS')} className="text-purple-400">TS%</th></tr></thead><tbody className="text-xs font-bold divide-y divide-white/5">{seasonStats.map(p=>(<tr key={p.name} className="stat-row"><td className="p-3 sticky left-0 bg-zinc-900/50">{p.name}</td><td className="p-3 text-gold stat-val">{p.ppg}</td><td className="p-3 stat-val">{p.rpg}</td><td className="p-3 stat-val">{p.apg}</td><td className="p-3 stat-val">{p.spg}</td><td className="p-3 stat-val">{p.bpg}</td><td className="p-3 stat-val text-zinc-400">{p.topg}</td><td className="p-3 stat-val">{p.fgPct}%</td><td className="p-3 stat-val text-blue-400">{p.eFG}%</td><td className="p-3 stat-val text-purple-400">{p.TS}%</td></tr>))}</tbody></table></div>
                        </div>
                    )}

                    {view === 'trends' && (
                        <div className="space-y-6 animate-slideIn">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {trendSummaries.length > 0 ? trendSummaries.map((t,i)=>(
                                    <div key={i} className={`trend-card border-${t.type==='good'?'green-500':(t.type==='bad'?'red-500':'yellow-500')}`}>
                                        <div className="trend-title text-white">{t.title}</div>
                                        <div className="trend-desc">{t.desc}</div>
                                    </div>
                                )) : <div className="col-span-3 text-center text-zinc-500 p-4">Need at least 2 games to analyze trends.</div>}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div className="bento-card h-64"><h3 className="text-xs font-black uppercase mb-2">Scoring</h3><TrendChart games={games} type="score"/></div>
                                <div className="bento-card h-64"><h3 className="text-xs font-black uppercase mb-2">FG Efficiency</h3><TrendChart games={games} type="fg"/></div>
                                <div className="bento-card h-64"><h3 className="text-xs font-black uppercase mb-2">3PT %</h3><TrendChart games={games} type="3pt"/></div>
                                <div className="bento-card h-64"><h3 className="text-xs font-black uppercase mb-2">Turnovers</h3><TrendChart games={games} type="to"/></div>
                                <div className="bento-card h-64"><h3 className="text-xs font-black uppercase mb-2">Rebounds</h3><TrendChart games={games} type="reb"/></div>
                                <div className="bento-card h-64"><h3 className="text-xs font-black uppercase mb-2">Free Throws</h3><TrendChart games={games} type="ft"/></div>
                            </div>
                        </div>
                    )}

                    {view === 'profiles' && (
                        <div className="animate-slideIn">
                            <div className="mb-6 overflow-x-auto pb-2 no-print"><div className="flex gap-2">{ROSTER.map(p=>(<button key={p.id} onClick={()=>setSelectedProfile(p.name)} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase whitespace-nowrap border transition ${selectedProfile===p.name?'bg-white text-black border-white':'bg-black text-zinc-500 border-zinc-800'}`}>#{p.id} {p.name}</button>))}</div></div>
                            <div className="print-header"><h1 className="text-4xl font-black uppercase">Scouting Report</h1><p className="text-lg">{selectedProfile}</p></div>
                            <div className="bento-card relative overflow-hidden mb-6"><div className="absolute top-0 right-0 p-8 opacity-10 font-black italic text-9xl">{playerInfo.id}</div><div className="relative z-10 flex justify-between items-end"><div><h2 className="text-4xl md:text-6xl font-black italic uppercase leading-none">{playerInfo.name}</h2><div className="mt-2 text-sm font-bold text-zinc-500">{profile.totals.gp} Games ‚Ä¢ {profile.totals.pts} Pts</div></div><button onClick={()=>window.print()} className="no-print bg-white text-black px-6 py-2 rounded-full font-bold uppercase text-xs hover:bg-gold transition shadow-lg">üñ®Ô∏è PDF</button></div></div>
                            <div className="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6"><StatBox label="PPG" val={profile.avgs.ppg} color="text-gold" /><StatBox label="eFG%" val={profile.pcts.eFG+'%'} color="text-blue-400" /><StatBox label="TS%" val={profile.pcts.TS+'%'} color="text-purple-400" /><StatBox label="RPG" val={profile.avgs.rpg} /><StatBox label="APG" val={profile.avgs.apg} /><StatBox label="FG%" val={profile.pcts.fg+'%'} /></div>
                            
                            <div className="bento-card mb-6 border-l-4 border-blue-400"><h3 className="text-xs font-bold text-zinc-500 uppercase mb-2">üß† Metric Decoder</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs"><div><span className="font-bold text-blue-400">eFG% (Effective FG%):</span> Adjusts for the fact that a 3-pointer is worth 50% more than a 2-pointer. <br/><span className="text-zinc-500 italic">Formula: (FGM + 0.5 * 3PM) / FGA</span></div><div><span className="font-bold text-purple-400">TS% (True Shooting %):</span> The gold standard for efficiency. Includes 2s, 3s, and Free Throws. <br/><span className="text-zinc-500 italic">Formula: PTS / (2 * (FGA + 0.44 * FTA))</span></div></div></div>

                            <div className="print-grid grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bento-card"><h3 className="text-lg font-black uppercase text-gold mb-4 border-b border-white/10 pb-2">Splits</h3><div className="space-y-4"><SplitBar label="Field Goal" make={profile.totals.fg2m+profile.totals.fg3m} att={profile.totals.fg2a+profile.totals.fg3a} pct={profile.pcts.fg} /><SplitBar label="3-Point" make={profile.totals.fg3m} att={profile.totals.fg3a} pct={profile.pcts.fg3} /><SplitBar label="Free Throw" make={profile.totals.ftm} att={profile.totals.fta} pct={profile.pcts.ft} /></div></div>
                                <div className="bento-card"><h3 className="text-lg font-black uppercase text-gold mb-4 border-b border-white/10 pb-2">Highs</h3><div className="grid grid-cols-2 gap-4"><HighBox label="Pts" val={profile.highs.pts}/><HighBox label="Reb" val={profile.highs.reb}/><HighBox label="Ast" val={profile.highs.ast}/><HighBox label="Stl" val={profile.highs.stl}/><HighBox label="Blk" val={profile.highs.blk}/></div></div>
                            </div>
                        </div>
                    )}

                    {view === 'log' && (
                        <div className="grid gap-4">{games.map(g=><div key={g.id} className="bento-card flex justify-between items-center"><div><div className="text-xs font-bold text-zinc-500">{g.date}</div><div className="text-xl font-black italic"><span className={g.result==='W'?'text-green-500':'text-red-500'}>{g.result}</span> {g.teamScore}-{g.oppScore} vs {g.opp}</div></div><button onClick={()=>{setEditId(g.id);setGameMeta({date:g.date,opp:g.opp,oppScore:g.oppScore,venue:g.venue});setPlayStats(g.playStats||[]);setOpponentStats(g.opponentStats||{fg2m:0,fg2a:0,fg3m:0,fg3a:0,ftm:0,fta:0});const sm={};g.stats.forEach(s=>sm[s.name]=s);setPlayerStats(sm);setView('new');}} className="bg-zinc-800 text-xs font-bold uppercase p-2 rounded hover:bg-white hover:text-black">Edit</button></div>)}</div>
                    )}

                    {view === 'admin' && (
                        <div className="space-y-6 animate-slideIn">
                            <h2 className="text-2xl font-black italic uppercase text-gold">System Admin</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bento-card hover:bg-zinc-900 transition flex flex-col items-center text-center"><div className="text-4xl mb-4">üì•</div><h3 className="font-bold text-lg mb-2">Backup Database</h3><p className="text-xs text-zinc-500 mb-4">Export all games, shots, and stats to a CSV file.</p><button onClick={exportData} className="w-full py-2 bg-blue-600 rounded font-bold uppercase text-xs hover:bg-blue-500">Download CSV</button></div>
                                <div className="bento-card hover:bg-zinc-900 transition flex flex-col items-center text-center"><div className="text-4xl mb-4">üì§</div><h3 className="font-bold text-lg mb-2">Restore Data</h3><p className="text-xs text-zinc-500 mb-4">Import games from a backup CSV file.</p><label className="w-full py-2 bg-zinc-700 rounded font-bold uppercase text-xs hover:bg-zinc-600 cursor-pointer">Select File<input type="file" accept=".csv" className="hidden" onChange={importData} /></label></div>
                                <div className="bento-card hover:bg-red-900/10 border-red-900/50 flex flex-col items-center text-center"><div className="text-4xl mb-4">üóëÔ∏è</div><h3 className="font-bold text-lg mb-2 text-red-500">Purge Database</h3><p className="text-xs text-zinc-500 mb-4">Permanently delete all records from the cloud.</p><button onClick={purgeData} className="w-full py-2 bg-red-600 rounded font-bold uppercase text-xs hover:bg-red-500">Purge All</button></div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: SUBSTITUTION (1-for-1) */}
                    {subTarget !== null && ( 
                        <div className="modal-overlay" onClick={() => setSubTarget(null)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><div><div className="text-xs font-bold text-red-500 uppercase tracking-widest">SUBSTITUTING OUT</div><div className="text-3xl font-black italic uppercase text-white">{ROSTER.find(r=>r.id===subTarget).name}</div></div><button onClick={() => setSubTarget(null)} className="bg-zinc-800 w-10 h-10 rounded-full font-bold">‚úï</button></div>
                                <h3 className="text-sm font-bold text-green-500 uppercase tracking-widest mb-3">WHO IS CHECKING IN?</h3>
                                <div className="grid grid-cols-1 gap-2">{benchPlayers.map(p => (<button key={p.id} onClick={() => handleSubIn(p.id)} className="player-card-bench hover:scale-[1.02] transition-transform"><div className="flex items-center gap-4"><span className="font-black text-xl text-zinc-500 w-8">#{p.id}</span><div className="text-left"><div className="font-bold text-white">{p.name}</div><div className="text-xs text-zinc-500">{p.pos}</div></div></div><div className="bg-green-900 text-green-200 text-xs font-bold px-3 py-1 rounded-full uppercase">Sub In</div></button>))}</div>
                            </div>
                        </div>
                    )}
                    
                    {/* MODAL: SNAPSHOT */}
                    {showSnapshot && (
                        <div className="modal-overlay" onClick={() => setShowSnapshot(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6"><h3 className="text-2xl font-black uppercase text-gold">Game Snapshot</h3><button onClick={() => setShowSnapshot(false)} className="text-2xl">‚úï</button></div>
                                <div className="snap-grid">
                                    <div className="snap-stat-box"><div className="snap-stat-label">SHOOTING</div><div className={`snap-stat-val ${insights.fgPct>=45?'text-green-500':(insights.fgPct<35?'text-red-500':'text-white')}`}>{insights.teamFGM}/{insights.teamFGA}</div><div className="snap-stat-sub">{insights.fgPct}%</div></div>
                                    <div className="snap-stat-box"><div className="snap-stat-label">FREE THROWS</div><div className="snap-stat-val">{insights.teamFTM}/{insights.teamFTA}</div><div className="snap-stat-sub">{insights.ftPct}%</div></div>
                                    <div className="snap-stat-box"><div className="snap-stat-label">REBOUNDS</div><div className="snap-stat-val text-blue-500">{insights.teamReb}</div></div>
                                    <div className="snap-stat-box"><div className="snap-stat-label">TURNOVERS</div><div className={`snap-stat-val ${insights.teamTO>=12?'text-red-500':'text-white'}`}>{insights.teamTO}</div></div>
                                </div>
                                <div className="outlier-section">
                                    {insights.hotPlayers.map(p=><div key={p.name} className="outlier-card border-green-500"><div className="outlier-icon">üî•</div><div className="outlier-name">{p.name}</div><div className="outlier-detail">{p.val}</div></div>)}
                                    {insights.coldPlayers.map(p=><div key={p.name} className="outlier-card border-red-500"><div className="outlier-icon">üßä</div><div className="outlier-name">{p.name}</div><div className="outlier-detail">{p.val}</div></div>)}
                                    {insights.foulTrouble.map(p=><div key={p.name} className="outlier-card border-yellow-500"><div className="outlier-icon">‚ö†Ô∏è</div><div className="outlier-name">{p.name}</div><div className="outlier-detail">{p.val}</div></div>)}
                                    {insights.hotPlayers.length===0 && insights.coldPlayers.length===0 && insights.foulTrouble.length===0 && <div className="text-center text-zinc-500 italic text-sm p-4">No significant outliers detected yet.</div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function MiniStat({label, value, color, sub}) { return (<div className="bento-card flex flex-col items-center justify-center py-4"><div className="text-[9px] font-black uppercase text-zinc-500 tracking-widest mb-1">{label}</div><div className={`text-2xl lg:text-3xl font-black italic tracking-tighter ${color||'text-white'}`}>{value}</div>{sub && <div className="text-[8px] text-zinc-600 font-bold">{sub}</div>}</div>); }
        function Leaderboard({ title, icon, players, valFunc, label }) { return (<div className="bento-card h-full"><div className="flex items-center gap-2 mb-4 border-b border-white/5 pb-2"><span className="text-lg">{icon}</span><h3 className="text-sm font-black uppercase text-zinc-400 tracking-wider">{title}</h3></div><div className="space-y-1">{players.map((p, i) => (<div key={i} className="leader-row"><div className="flex items-center gap-2"><span className="rank-badge">{i+1}</span><span className="leader-name">{p.name.split(' ')[0]} {p.name.split(' ')[1][0]}.</span></div><div className="flex items-end"><span className="leader-val">{valFunc(p)}</span>{i===0 && <span className="leader-sub">{label}</span>}</div></div>))}</div></div>); }
        function HonorCard({ label, data, color }) { return (<div className="bg-black/40 border border-white/5 p-3 rounded-lg text-center"><div className="text-[9px] font-bold text-zinc-500 uppercase">{label}</div><div className={`text-2xl font-black ${color}`}>{data.val}</div>{data.val>0 && <div className="text-[8px] text-zinc-400 mt-1">{data.player.split(' ')[0]}</div>}</div>); }
        function TrendChart({ games, type }) {
            const ref = React.useRef(null);
            React.useEffect(() => {
                if(!ref.current || !games.length) return;
                const sorted = [...games].reverse();
                const labels = sorted.map(g => (g.opp || 'Unk').substring(0,4));
                let d1=[], d2=[], label1='', label2='', color1='#FFB81C', color2='#ef4444';
                if (type === 'score') { label1='Us'; label2='Them'; d1=sorted.map(g=>g.teamScore||0); d2=sorted.map(g=>g.oppScore||0); }
                else if (type === 'fg') { label1='FG%'; d1=sorted.map(g=>{let m=0,a=0;(g.stats||[]).forEach(s=>{m+=(s.fg2m+s.fg3m);a+=(s.fg2a+s.fg3a)}); return a>0?((m/a)*100).toFixed(1):0;}); }
                else if (type === '3pt') { label1='3PT%'; d1=sorted.map(g=>{let m=0,a=0;(g.stats||[]).forEach(s=>{m+=s.fg3m;a+=s.fg3a}); return a>0?((m/a)*100).toFixed(1):0;}); }
                else if (type === 'to') { label1='TO'; d1=sorted.map(g=>(g.stats||[]).reduce((acc,s)=>acc+(s.to||0),0)); color1='#ef4444'; }
                else if (type === 'reb') { label1='REB'; d1=sorted.map(g=>(g.stats||[]).reduce((acc,s)=>acc+(s.reb||0),0)); color1='#3b82f6'; }
                else if (type === 'ft') { label1='FT%'; d1=sorted.map(g=>{let m=0,a=0;(g.stats||[]).forEach(s=>{m+=s.ftm;a+=s.fta}); return a>0?((m/a)*100).toFixed(1):0;}); color1='#22c55e'; }

                const datasets = [{ label:label1, data:d1, borderColor:color1, backgroundColor:color1, tension:0.3 }];
                if(d2.length) datasets.push({ label:label2, data:d2, borderColor:color2, backgroundColor:color2, tension:0.3 });
                
                const chart = new Chart(ref.current.getContext('2d'), { type: type==='to'?'bar':'line', data:{labels,datasets}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'white'}}}, scales:{y:{grid:{color:'#333'},ticks:{color:'#888'}}, x:{grid:{display:false}}}}});
                return () => chart.destroy();
            }, [games, type]);
            return games.length ? <canvas ref={ref} /> : <div className="h-full flex items-center justify-center text-zinc-500 text-xs">No Data</div>;
        }

        function StatBox({label, val, color}) { return (<div className="bento-card text-center py-4"><div className="text-[10px] font-black uppercase text-zinc-500 tracking-widest mb-1">{label}</div><div className={`text-3xl font-black italic tracking-tighter ${color||'text-white'}`}>{val}</div></div>); }
        function HighBox({label, val}) { return (<div className="bg-black/40 border border-white/5 p-3 rounded-lg text-center"><div className="text-[9px] font-bold text-zinc-500 uppercase">{label}</div><div className="text-2xl font-black text-white">{val}</div></div>); }
        function SplitBar({label, make, att, pct}) { return (<div><div className="flex justify-between text-xs font-bold mb-1"><span className="text-zinc-400 uppercase">{label}</span><span>{make}/{att} <span className={`ml-1 ${pct>=50?'text-green-500':(pct<30?'text-red-500':'text-gold')}`}>({pct}%)</span></span></div><div className="h-2 bg-black rounded-full overflow-hidden border border-zinc-800"><div style={{width: `${pct}%`}} className={`h-full ${pct>=40?'bg-green-500':'bg-zinc-600'}`}></div></div></div>); }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
